# 멀티 서비스 파이프라인 아키텍처

**작성일**: 2025-11-20  
**버전**: 1.0

---

## 개요

IaaS 서비스 운영 환경에서 각 고객(서비스)마다 독립적인 Jenkins 파이프라인을 구성하는 아키텍처입니다.

---

## 왜 각 서비스마다 독립 파이프라인이 필요한가?

### 운영 환경 특성

- **운영자**: IaaS 서비스 제공자
- **고객 수**: 10~20개의 독립적인 고객
- **각 고객**: 독립적인 서비스 및 인프라 운영

### 독립 파이프라인의 장점

1. **격리성 (Isolation)**
   - 각 서비스의 스케일아웃이 서로 영향을 주지 않음
   - 한 서비스의 문제가 다른 서비스에 전파되지 않음

2. **독립 설정 (Independent Configuration)**
   - 서비스별로 다른 스케일링 정책 적용 가능
   - 서비스별로 다른 템플릿, IP Pool, F5 Pool 사용

3. **독립 로그 (Independent Logging)**
   - 서비스별 빌드 로그 및 이벤트 추적 용이
   - 문제 발생 시 특정 서비스의 로그만 확인하면 됨

4. **동시 실행 (Concurrent Execution)**
   - 여러 서비스가 동시에 스케일아웃 요청해도 충돌 없음
   - Jenkins Executor를 효율적으로 활용

5. **관리 용이성 (Easy Management)**
   - 서비스별로 파이프라인 상태 모니터링 및 관리 가능
   - 서비스별로 파이프라인 활성화/비활성화 가능

6. **보안 (Security)**
   - 서비스별로 다른 Credential 및 권한 관리 가능
   - 서비스 간 정보 유출 방지

---

## 아키텍처 설계

### Job 명명 규칙

```
autoscale-{service-name}
또는
autoscale-{customer-name}-{service-name}
```

**예시**:
- `autoscale-web-server-service`
- `autoscale-customer-a-web-server`
- `autoscale-customer-b-api-server`
- `autoscale-ecommerce-frontend`

### Webhook Token 명명 규칙

```
{job-name}-token
```

**예시**:
- `autoscale-web-server-service-token`
- `autoscale-customer-a-web-server-token`

### Webhook URL 형식

```
http://10.255.0.103:8080/generic-webhook-trigger/invoke?token={webhook-token}
```

**예시**:
- `http://10.255.0.103:8080/generic-webhook-trigger/invoke?token=autoscale-web-server-service-token`

---

## 워크플로우

### 1. 오토스케일링 설정 생성 시

```
운영자가 웹 UI에서 오토스케일링 설정 생성
  ↓
Backend API가 설정 저장
  ↓
Backend가 Jenkins API를 호출하여 서비스별 Job 자동 생성
  ↓
Job 생성 완료
  - Job 이름: autoscale-{service-name}
  - Webhook Token: {job-name}-token
  - Webhook URL: http://10.255.0.103:8080/generic-webhook-trigger/invoke?token={token}
  ↓
Alertmanager 설정에 서비스별 라우팅 규칙 추가
  ↓
설정 완료
```

### 2. 스케일아웃 트리거 시

```
Prometheus가 메트릭 수집
  ↓
Alert Rule 평가 → Alert 생성
  ↓
Alertmanager가 Alert 수신
  ↓
서비스별 라우팅 규칙에 따라 해당 서비스의 Webhook URL로 전송
  ↓
해당 서비스의 Jenkins Job이 실행
  ↓
독립적인 파이프라인 실행
  - VM 생성
  - IP 할당
  - Ping 테스트
  - F5 Pool 추가
```

---

## 구현 예시

### 서비스별 Job 생성 (백엔드)

```javascript
// 오토스케일링 설정 생성 시
const config = {
  serviceName: "Web-Server-Service",
  // ... 기타 설정
};

// Jenkins Job 자동 생성
const jenkinsJob = await jenkinsService.createJenkinsJob(config);
// 결과:
// {
//   jobName: "autoscale-web-server-service",
//   webhookToken: "autoscale-web-server-service-token",
//   webhookUrl: "http://10.255.0.103:8080/generic-webhook-trigger/invoke?token=autoscale-web-server-service-token"
// }
```

### Alertmanager 라우팅 설정

```yaml
route:
  routes:
    - match:
        service: web-server-service
      receiver: 'jenkins-webhook-web-server'
    - match:
        service: api-server-service
      receiver: 'jenkins-webhook-api-server'

receivers:
  - name: 'jenkins-webhook-web-server'
    webhook_configs:
      - url: 'http://10.255.0.103:8080/generic-webhook-trigger/invoke?token=autoscale-web-server-service-token'
  
  - name: 'jenkins-webhook-api-server'
    webhook_configs:
      - url: 'http://10.255.0.103:8080/generic-webhook-trigger/invoke?token=autoscale-api-server-service-token'
```

---

## 관리 및 모니터링

### 서비스별 Job 목록 확인

```bash
# Jenkins 서버 접속
ssh jenkins@10.255.0.103

# Job 목록 확인
echo "!danacloud12" | sudo -S ls -la /var/lib/jenkins/jobs/ | grep autoscale

# 예상 출력:
# drwxr-xr-x  jenkins jenkins  autoscale-web-server-service
# drwxr-xr-x  jenkins jenkins  autoscale-api-server-service
# drwxr-xr-x  jenkins jenkins  autoscale-ecommerce-frontend
```

### 서비스별 빌드 로그 확인

```bash
# 특정 서비스의 최신 빌드 로그
echo "!danacloud12" | sudo -S tail -100 \
  /var/lib/jenkins/jobs/autoscale-web-server-service/builds/lastSuccessfulBuild/log
```

### 서비스별 Job 비활성화

```bash
# Web UI에서: Job 설정 → "Disable this project" 체크
# 또는 API로:
curl -X POST \
  -u danacloud:!danacloud12 \
  "http://10.255.0.103:8080/job/autoscale-web-server-service/disable"
```

---

## 확장성 고려사항

### Jenkins Executor 수

- 각 서비스가 동시에 스케일아웃 요청할 수 있으므로 충분한 Executor 필요
- 권장: 최소 고객 수만큼의 Executor (예: 20개)

### Alertmanager 라우팅 규칙 관리

- 서비스가 많아지면 라우팅 규칙이 복잡해질 수 있음
- 자동화된 설정 관리 시스템 필요

### Job 관리

- 서비스 삭제 시 해당 Job도 삭제해야 함
- Job 정리 스크립트 필요

---

## 보안 고려사항

### Webhook Token 보안

- 각 서비스별로 고유한 Token 사용
- Token은 안전하게 저장 및 관리

### Credential 관리

- 서비스별로 다른 vCenter, F5 Credential 사용 가능
- Jenkins Credential 시스템 활용

---

## 요약

각 서비스(고객)마다 독립적인 Jenkins 파이프라인을 구성함으로써:

✅ **격리성**: 서비스 간 영향 없음  
✅ **독립성**: 서비스별 독립 설정 및 로그  
✅ **확장성**: 10~20개 서비스 동시 운영 가능  
✅ **관리 용이성**: 서비스별 모니터링 및 관리  
✅ **보안**: 서비스별 Credential 및 권한 관리

---

**작성자**: Dana Cloud Automation Team  
**최종 수정일**: 2025-11-20

