# VM 오토스케일링 프로젝트 작업 이력 및 개선사항

## 📋 목차
1. [PLG Stack 모니터링 등록 메뉴 개선](#plg-stack-모니터링-등록-메뉴-개선)
2. [오토스케일링 기능 강화](#오토스케일링-기능-강화)
3. [스케일인 기능 구현](#스케일인-기능-구현)
4. [모니터링 대시보드 개선](#모니터링-대시보드-개선)
5. [하드코딩 값 점검 및 수정](#하드코딩-값-점검-및-수정)
6. [Alert Rule 로직 개선](#alert-rule-로직-개선)

---

## PLG Stack 모니터링 등록 메뉴 개선

### 1.1 JMX 대시보드 선택 기능 추가
**요구사항**: 모든 서버가 JVM을 사용하는 것이 아니므로 JMX 대시보드 생성을 선택 가능하게 변경

**구현 내용**:
- 대시보드 타입을 체크박스로 선택 가능하도록 변경
- 인프라 대시보드와 JVM 대시보드 중복 선택 가능
- 선택하지 않으면 대시보드 생성 안 함

**수정 파일**:
- `frontend/src/components/PrometheusMonitoring.jsx`
- `backend/src/services/prometheusMonitoringService.js`

**코드 변경**:
```javascript
// 프론트엔드: 체크박스로 대시보드 타입 선택
const [dashboardTypes, setDashboardTypes] = useState({
  infra: false,
  jvm: false
});

// 백엔드: dashboardOptions로 전달
const dashboardOptions = {
  createInfraDashboard: dashboardTypes.infra,
  createJvmDashboard: dashboardTypes.jvm,
  enableLoki: enableLoki
};
```

### 1.2 Loki 연동 선택 기능 추가
**요구사항**: Loki 연동을 선택 가능하게 변경

**구현 내용**:
- Loki 연동(Promtail)을 체크박스로 선택 가능
- 선택하지 않으면 Promtail 설치/설정 안 함

**수정 파일**:
- `frontend/src/components/PrometheusMonitoring.jsx`
- `backend/src/services/prometheusMonitoringService.js`

### 1.3 묶어서 등록 기능 추가
**요구사항**: 여러 VM을 하나의 Prometheus Job으로 묶어서 등록 가능하도록 개선

**구현 내용**:
- Job 등록 모드 선택: 개별 등록 / 묶어서 등록
- 묶어서 등록 시 Job 이름을 사용자가 입력
- 여러 VM을 하나의 Job으로 묶어서 등록

**수정 파일**:
- `frontend/src/components/PrometheusMonitoring.jsx`
- `backend/src/services/prometheusMonitoringService.js`

**사용 시나리오**:
- 서비스 레벨 오토스케일링을 위해 여러 VM을 하나의 Job으로 묶어서 등록
- 새로 스케일아웃된 VM도 자동으로 같은 Job에 추가됨

### 1.4 UI/UX 개선
**구현 내용**:
- "등록된 Job 목록"과 "Alertmanager 라우팅 규칙" 섹션에 새로고침 버튼 추가
- 섹션 순서 변경: "Alertmanager 라우팅 규칙"을 먼저 표시
- 카드 스타일 적용으로 일관된 UI 제공
- 테이블 컬럼 너비 조정으로 모든 버튼이 보이도록 개선

**수정 파일**:
- `frontend/src/components/PrometheusMonitoring.jsx`
- `frontend/src/components/AutoscalingConfigList.jsx`

---

## 오토스케일링 기능 강화

### 2.1 최대 VM 개수 제한 로직 추가
**요구사항**: 최대 VM 개수에 도달하면 스케일아웃을 차단해야 함

**구현 내용**:
- Alertmanager webhook 핸들러에서 스케일아웃 시 현재 VM 개수 확인
- Prometheus Job에서 등록된 target 개수 확인
- 현재 VM 개수가 `maxVms` 이상이면 스케일아웃 거부

**수정 파일**:
- `backend/src/server.js`

**코드 위치**:
```javascript
// 스케일아웃인 경우 최대 VM 개수 체크
if (isScaleOut) {
  const maxVms = config.scaling?.maxVms || 10;
  const currentVmCount = targetsResult.targets.length;
  
  if (currentVmCount >= maxVms) {
    // 스케일아웃 거부
    return;
  }
}
```

### 2.2 스케일아웃 프로세스 개선
**구현 내용**:
- VM 생성 후 백엔드 webhook으로 알림 전송
- 백엔드에서 Prometheus Job에 새 target 자동 추가
- F5 Pool Member 추가 완료 후 서비스 투입
- 쿨다운 시작 (기본 5분)

**프로세스 순서**:
1. Alertmanager → 백엔드 webhook
2. 백엔드: 쿨다운 체크, 최대 VM 개수 체크
3. 백엔드 → Jenkins 트리거
4. Jenkins: VM Clone → Customization → 전원 켜기 → F5 Pool Member 추가
5. Jenkins → 백엔드 webhook (VM 생성 완료)
6. 백엔드: Prometheus Job에 target 추가, 쿨다운 시작

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale.linux`
- `backend/src/server.js`
- `backend/src/services/prometheusMonitoringService.js`

### 2.3 쿨다운 메커니즘 구현
**구현 내용**:
- 스케일아웃/스케일인 후 쿨다운 기간 동안 같은 액션 차단
- 쿨다운 기간은 설정에서 변경 가능 (기본 5분)
- 파일 기반 쿨다운 상태 관리

**수정 파일**:
- `backend/src/services/cooldownService.js` (신규 생성)
- `backend/src/server.js`

**동작 방식**:
- 스케일아웃 완료 후 쿨다운 시작 (5분)
- 쿨다운 중에는 같은 서비스의 스케일아웃 요청 차단
- 쿨다운 종료 후 다음 스케일아웃 가능

---

## 스케일인 기능 구현

### 3.1 스케일인 Alert Rule 생성
**구현 내용**:
- 스케일인 Alert Rule 자동 생성
- 모든 서버의 CPU와 Memory가 임계값 이하일 때 Alert 발생
- `max()` 함수 사용으로 모든 서버가 낮아야 스케일인 발생

**수정 파일**:
- `backend/src/services/prometheusAlertService.js`

**Alert Rule 표현식**:
```promql
max(CPU_사용률) < 30 AND max(Memory_사용률) < 30
```

### 3.2 VM 선택 로직 (LIFO, 타임스탬프 우선)
**요구사항**: 스케일아웃으로 생성된 VM을 우선 삭제하고, 최신 VM부터 삭제

**구현 내용**:
- 타임스탬프가 있는 VM(스케일아웃 생성) 우선 선택
- 타임스탬프 내림차순 정렬 (최신 VM부터)
- 타임스탬프가 없는 VM(최초 생성)은 보호

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale-in`

**VM 이름 패턴**:
- 스케일아웃 생성: `vmPrefix-YYYYMMDDHHMM` (예: `auto-vm-test-202512111531`)
- 최초 생성: 타임스탬프 없음 (예: `auto-vm-test-01`)

### 3.3 스케일인 프로세스 구현
**프로세스 순서**:
1. Alertmanager → 백엔드 webhook
2. 백엔드: 쿨다운 체크, 최소 VM 개수 체크
3. 백엔드 → Jenkins 트리거 (삭제할 VM 정보 포함)
4. Jenkins: VM 선택 (LIFO, 타임스탬프 우선)
5. Jenkins: F5 Pool Member 제거 → F5 Node 삭제
6. Jenkins: Prometheus target 제거 (백엔드 API 호출)
7. Jenkins: vCenter에서 VM 삭제 (전원 종료 → 삭제)
8. Jenkins → 백엔드 webhook (VM 삭제 완료)
9. 백엔드: 쿨다운 시작

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale-in`
- `backend/src/server.js`
- `backend/src/services/prometheusMonitoringService.js`

### 3.4 F5 Node 삭제 기능 추가
**구현 내용**:
- F5 Pool Member 제거 후 F5 Node도 삭제
- Python 스크립트를 사용하여 F5 BigIP REST API 호출

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale-in`

### 3.5 Prometheus Target 제거 검증
**구현 내용**:
- 백엔드 API를 통해 Prometheus target 제거
- Prometheus API를 직접 호출하여 제거 확인
- 제거 실패 시 파이프라인 실패 처리

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale-in`
- `backend/src/server.js`
- `backend/src/services/prometheusMonitoringService.js`

---

## 모니터링 대시보드 개선

### 4.1 Prometheus 메트릭 조회 API 추가
**문제**: 프론트엔드에서 Prometheus API를 직접 호출 시 CORS 문제 발생

**해결 방법**:
- 백엔드에 Prometheus 쿼리 프록시 API 추가
- 프론트엔드는 백엔드를 통해 Prometheus 데이터 조회

**추가된 API**:
- `GET /api/prometheus/query`: Prometheus 단일 쿼리
- `GET /api/prometheus/query_range`: Prometheus 범위 쿼리

**수정 파일**:
- `backend/src/server.js`
- `frontend/src/services/monitoringApi.js`

### 4.2 설정 없을 때 안내 메시지 표시
**구현 내용**:
- 오토스케일링 설정이 없을 때 안내 메시지 표시
- 설정 방법 안내

**수정 파일**:
- `frontend/src/components/MonitoringDashboard.jsx`

---

## 하드코딩 값 점검 및 수정

### 5.1 고정 서버 IP 주소 설정
**요구사항**: Jenkins, PLG Stack, VM Autoscaling 서버는 고정으로 사용

**구현 내용**:
- 고정 서버 IP를 기본값으로 설정
- 환경 변수로 오버라이드 가능하도록 유지

**고정 서버**:
- Jenkins 서버: `10.255.0.103:8080`
- PLG Stack 서버: `10.255.1.254`
- VM Autoscaling 서버: `10.255.48.253:6010`
- F5 서버: `10.255.1.80`

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale.linux`
- `jenkins/Jenkinsfile.autoscale-in`
- `frontend/src/components/AlertmanagerRouting.jsx`
- `backend/src/server.js`

### 5.2 사용자 입력 값 하드코딩 제거
**확인 결과**:
- VM IP 대역, VLAN 이름, 서비스 이름 등은 모두 설정에서 동적으로 입력
- 코드에 하드코딩된 값 없음

**확인 항목**:
- ✅ VM IP 대역: 설정에서 동적 입력
- ✅ VLAN 이름: 드롭다운에서 동적 선택
- ✅ 서비스 이름: 설정에서 동적 입력
- ✅ VM Prefix: 설정에서 동적 입력
- ✅ F5 Pool 이름: 설정에서 동적 입력

---

## Alert Rule 로직 개선

### 6.1 스케일인 Alert Rule 수정 (min → max)
**문제**: `min()` 함수 사용 시 일부 서버만 낮아도 스케일인 발생

**수정 내용**:
- `min()` → `max()` 함수로 변경
- 모든 서버가 임계값 이하일 때만 스케일인 발생

**수정 전**:
```promql
min(CPU_사용률) < 30  // 최소값만 확인 → 일부 서버만 낮아도 스케일인 발생
```

**수정 후**:
```promql
max(CPU_사용률) < 30  // 최대값 확인 → 모든 서버가 낮아야 스케일인 발생
```

**수정 파일**:
- `backend/src/services/prometheusAlertService.js`

**예시**:
- 서버 A: 25%, 서버 B: 28%, 서버 C: 35%
- `max()` = 35% < 30% → false → 스케일인 발생 안 함 ✅
- 서버 A: 25%, 서버 B: 28%, 서버 C: 29%
- `max()` = 29% < 30% → true → 스케일인 발생 ✅

---

## 버그 수정 및 개선사항

### 7.1 템플릿 이름 공백 문제 해결
**문제**: 템플릿 이름에 앞뒤 공백이 포함되어 vCenter에서 찾을 수 없음

**해결 방법**:
- 프론트엔드에서 입력 시 공백 제거 (`trimStart()`, `trim()`)
- 저장 전 공백 검증 및 경고 메시지 표시
- 백엔드에서도 저장 시 공백 제거

**수정 파일**:
- `frontend/src/components/TemplateForm.jsx`
- `backend/src/services/templateService.js`

### 7.2 VLAN 선택 기능 추가
**문제**: Jenkins에서 하드코딩된 VLAN 이름 사용으로 인한 오류

**해결 방법**:
- 백엔드에 VLAN 목록 조회 API 추가
- 프론트엔드에서 드롭다운으로 VLAN 선택

**수정 파일**:
- `backend/src/services/templateService.js`
- `backend/src/server.js`
- `frontend/src/components/AutoscalingConfigForm.jsx`
- `frontend/src/services/api.js`

### 7.3 Jenkins 파이프라인 개선
**개선 사항**:
- Template 조회 로직 개선 (JSON 파싱 오류 해결)
- Customization Spec 선택적 사용 (없으면 직접 IP 설정)
- 환경 변수 중복 제거
- VM 이름 공백 처리

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale.linux`
- `jenkins/Jenkinsfile.autoscale-in`

### 7.4 스케일인 파이프라인 개선
**개선 사항**:
- VM 조회 최적화 (단일 `govc find` 명령 사용)
- VM 삭제 로직 강화 (경로 찾기, 전원 종료 대기, 삭제 확인)
- F5 Node 삭제 기능 추가
- Prometheus target 제거 검증 추가

**수정 파일**:
- `jenkins/Jenkinsfile.autoscale-in`

### 7.5 메뉴 이름 변경
**변경 내용**:
- "스케일아웃 이벤트" → "스케일아웃/인 이벤트"

**수정 파일**:
- `frontend/src/App.jsx`
- `frontend/src/components/ScaleOutEventList.jsx`

---

## 주요 기능 요약

### ✅ 완료된 기능

1. **PLG Stack 모니터링 등록**
   - JMX 대시보드 선택 가능
   - Loki 연동 선택 가능
   - 묶어서 등록 기능
   - UI/UX 개선

2. **오토스케일링**
   - 최대 VM 개수 제한
   - 쿨다운 메커니즘
   - 스케일아웃 프로세스 자동화
   - F5 L4 자동 연동

3. **스케일인**
   - 스케일인 Alert Rule 자동 생성
   - VM 선택 로직 (LIFO, 타임스탬프 우선)
   - F5 Pool Member/Node 제거
   - Prometheus target 제거
   - vCenter VM 삭제

4. **모니터링**
   - Prometheus 메트릭 조회 (CORS 문제 해결)
   - 실시간 CPU/Memory 사용률 표시
   - Alert 목록 표시

5. **코드 품질**
   - 하드코딩 값 제거
   - 환경 변수 지원
   - 에러 처리 개선

---

## 설정 가능한 값

### 환경 변수 (선택사항)
- `BACKEND_API_URL`: 백엔드 API 주소 (기본값: http://10.255.48.253:6010)
- `PLG_STACK_SERVER`: PLG Stack 서버 주소 (기본값: 10.255.1.254)
- `JENKINS_URL`: Jenkins 서버 주소 (기본값: http://10.255.0.103:8080)
- `F5_SERVER`: F5 서버 주소 (기본값: 10.255.1.80)
- `PROMETHEUS_URL`: Prometheus 주소 (기본값: http://10.255.1.254:9090)
- `ALERTMANAGER_URL`: Alertmanager 주소 (기본값: http://10.255.1.254:9093)

### 사용자 입력 값 (동적)
- VM IP 대역 (ipPoolStart, ipPoolEnd)
- VLAN 이름
- 서비스 이름
- VM Prefix
- F5 Pool 이름
- VIP 주소
- 최대/최소 VM 개수
- 임계값 (CPU, Memory)
- 쿨다운 기간

---

## 테스트 시나리오

### 스케일아웃 시나리오
1. 초기: 1번, 2번 서버 (총 2대)
2. 1번 서버가 90% CPU 사용 중 → Alert 발생
3. 3번 VM 생성 시작
4. VM 생성 완료 후 F5 Pool Member 추가 → 서비스 투입 (약 2-8분 소요)
5. 쿨다운 시작 (5분)
6. 1번 서버가 여전히 90% CPU 사용 중
7. 쿨다운 종료 후 (5분 후) 4번 VM 생성 시작

### 스케일인 시나리오
1. 모든 서버가 30% CPU 이하로 유지 (5분 이상)
2. Alert 발생
3. VM 선택 (스케일아웃 생성 VM 우선, 최신부터)
4. F5 Pool Member 제거 → F5 Node 삭제
5. Prometheus target 제거
6. vCenter에서 VM 삭제
7. 쿨다운 시작 (5분)

---

## 기술 스택

- **Frontend**: React, Vite, Recharts
- **Backend**: Node.js, Express (HTTP 서버)
- **Monitoring**: Prometheus, Grafana, Alertmanager
- **Logging**: Loki, Promtail
- **Automation**: Jenkins
- **Infrastructure**: vCenter (govc), F5 BigIP
- **Configuration**: YAML (Prometheus, Alertmanager)

---

## 접근 권한 및 향후 계획

### 현재 상태
- **접근 권한**: 관리자만 접근 가능
- **인증/인가**: 현재 단일 관리자 계정으로 운영
- **데이터 분리**: 고객별 데이터 분리 없음

### 향후 고도화 계획
- **고객별 분리 접근**: 고객별로 독립적인 접근 및 설정 관리
- **멀티 테넌시**: 고객별 데이터 격리 및 권한 관리
- **자체 관리**: 고객이 직접 오토스케일링 설정 및 모니터링 가능
- **인증/인가 강화**: 고객별 계정 관리 및 권한 제어

---

## 문서 작성일
2025년 12월 11일

