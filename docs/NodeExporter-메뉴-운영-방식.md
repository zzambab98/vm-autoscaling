# Node Exporter 설치 메뉴 운영 방식 설명

## 📋 메뉴 구성

### 1. 설치할 도구 선택
**위치**: 화면 상단의 회색 박스

**기능**:
- **Node Exporter 체크박스**: 메트릭 수집 도구 (포트 9100)
- **Promtail 체크박스**: 로그 수집 및 Loki 전송 도구 (포트 9080)

**운영 방식**:
- 두 도구를 독립적으로 선택/해제 가능
- 최소 하나 이상 선택해야 설치 버튼 활성화
- 선택한 도구만 설치됨

**설치 순서**:
1. Node Exporter가 선택된 경우 → 먼저 설치
2. Promtail이 선택된 경우 → Node Exporter 설치 후 설치
3. 각각의 설치 결과를 개별적으로 확인

---

### 2. SSH 설정
**위치**: 설치 옵션 선택 아래

**기능**:
- **SSH 사용자**: 서버 접속에 사용할 사용자명 (기본값: ubuntu)
- **SSH Key 선택**: 드롭다운에서 SSH 키 선택
  - 백엔드에서 `/home/ubuntu/workspace/vm-autoscaling/pemkey` 디렉토리의 키 목록을 동적으로 로드
  - "직접 입력" 선택 시 커스텀 경로 입력 가능

**운영 방식**:
- 페이지 로드 시 백엔드 API(`/api/ssh-config`)에서 SSH 키 목록과 기본값 로드
- 선택한 SSH 키로 모든 서버에 접속
- 환경 변수로 기본값 설정 가능 (`DEFAULT_SSH_USER`, `DEFAULT_SSH_KEY`)

---

### 3. 상단 버튼 그룹
**위치**: SSH 설정 아래

#### 3.1 VM 목록 새로고침
**기능**: vCenter에서 VM 목록을 다시 조회

**운영 방식**:
- 백엔드 API(`/api/templates/vms`) 호출
- vCenter에서 모든 VM 조회 (`govc find / -type m`)
- 각 VM의 IP 주소 조회 (재시도 로직 포함)
- `vCLS-`로 시작하는 VM 제외
- VM 이름 기준으로 정렬

**결과**:
- VM 목록 테이블 업데이트
- IP 주소가 없는 VM은 수동 입력 필드 표시
- IP가 여러 개인 VM은 선택 버튼 표시

---

#### 3.2 전체 상태 확인
**기능**: 모든 VM의 Node Exporter/Promtail 설치 상태 확인

**운영 방식**:
- 테이블에 표시된 모든 서버를 순차적으로 확인
- 각 서버에 SSH 접속하여 설치 상태 확인
- 서버당 약 100ms 간격으로 확인 (부하 방지)

**확인 내용**:
- Node Exporter: 서비스 상태, 바이너리 존재 여부, 메트릭 응답 확인
- Promtail: 서비스 상태, 바이너리 존재 여부, 설정 파일 존재 여부, HTTP 엔드포인트 확인

**결과**:
- 각 서버의 상태 배지 업데이트 (설치됨/미설치)
- 성공 메시지 표시: "전체 N개 서버 상태 확인 완료"

---

#### 3.3 전체 설치
**기능**: 모든 VM에 선택한 도구 설치

**운영 방식**:
1. **Node Exporter 설치** (선택된 경우)
   - 모든 서버에 순차적으로 설치
   - `autoRegisterPrometheus: true` 옵션으로 Prometheus 자동 등록
   - Grafana 대시보드 자동 생성
   - 설치 실패 시 Promtail 설치 중단

2. **Promtail 설치** (선택된 경우)
   - Node Exporter 설치 성공 후 진행
   - 각 서버에 순차적으로 설치
   - 설치 실패해도 Node Exporter는 유지

**결과**:
- 성공/실패 서버 수 표시
- 모든 서버 상태 자동 확인
- 상세한 에러 메시지 표시

---

### 4. VM 목록 테이블
**위치**: 화면 하단

**컬럼 구성**:
- **서버 이름**: VM 이름
- **IP 주소**: 
  - IP가 없으면: 수동 입력 필드
  - IP가 1개면: IP 주소 표시
  - IP가 여러 개면: 선택 버튼 표시
- **상태**: 
  - Node Exporter 설치 상태 (설치됨/미설치)
  - Promtail 설치 상태 (설치됨/미설치)
  - 선택한 도구만 표시
- **작업**: 개별 작업 버튼

---

### 5. 개별 작업 버튼

#### 5.1 확인 버튼
**기능**: 해당 서버의 설치 상태만 확인

**운영 방식**:
- SSH 접속하여 설치 상태 확인
- Node Exporter와 Promtail 상태 모두 확인
- 결과를 테이블에 즉시 반영

**결과**:
- 상태 배지 업데이트
- 성공 메시지: "서버명 (IP) 상태 확인 완료"

---

#### 5.2 설치 버튼
**기능**: 해당 서버에 선택한 도구 설치

**운영 방식**:
1. **Node Exporter 설치** (선택된 경우)
   - SSH 접속 테스트
   - 설치 스크립트 실행
   - Prometheus 자동 등록
   - Grafana 대시보드 자동 생성

2. **Promtail 설치** (선택된 경우)
   - Node Exporter 설치 성공 후 진행
   - SSH 접속 테스트
   - 설치 스크립트 실행

**결과**:
- 설치 중: 버튼이 "설치 중..."으로 변경
- 성공: "서버IP: Node Exporter + Promtail 설치 완료" 메시지
- 실패: 상세한 에러 메시지 표시
- 자동으로 상태 확인 실행

---

#### 5.3 삭제 버튼
**기능**: 설치된 도구 삭제

**표시 조건**: Node Exporter 또는 Promtail이 설치된 경우에만 표시

**운영 방식**:
- 확인 다이얼로그 표시
- 설치된 도구에 따라 삭제:
  - 둘 다 설치됨 → 둘 다 삭제
  - Node Exporter만 설치됨 → Node Exporter만 삭제
  - Promtail만 설치됨 → Promtail만 삭제

**결과**:
- 삭제 중: 버튼이 "삭제 중..."으로 변경
- 성공: "서버IP: Node Exporter + Promtail 삭제 완료" 메시지
- 자동으로 상태 확인 실행

---

## 🔄 전체 워크플로우

### 일반적인 사용 흐름

1. **초기 로드**
   - SSH 설정 로드 (키 목록, 기본값)
   - VM 목록 자동 로드 (vCenter에서 조회)

2. **설치 옵션 선택**
   - Node Exporter / Promtail 선택
   - SSH 사용자 및 키 설정

3. **상태 확인** (선택사항)
   - "전체 상태 확인" 또는 개별 "확인" 버튼 클릭
   - 설치 상태 확인

4. **설치**
   - "전체 설치" 또는 개별 "설치" 버튼 클릭
   - 선택한 도구 설치
   - 자동으로 상태 확인

5. **삭제** (필요시)
   - 개별 "삭제" 버튼 클릭
   - 설치된 도구 삭제

---

## 🔧 주요 특징

### 1. 동적 설정 로드
- SSH 키 목록을 백엔드에서 동적으로 로드
- 환경 변수로 기본값 설정 가능
- 하드코딩 없음

### 2. 에러 처리
- SSH 연결 실패 시 명확한 메시지
- 설치 실패 시 상세한 에러 정보
- 부분 실패도 명확히 표시

### 3. 상태 관리
- 실시간 상태 업데이트
- 설치/삭제 중 버튼 비활성화
- 진행 상황 표시

### 4. 자동화
- Node Exporter 설치 시 Prometheus 자동 등록
- Grafana 대시보드 자동 생성
- 설치 후 자동 상태 확인

---

## 📝 주의사항

1. **IP 주소 필수**
   - 설치/상태 확인을 위해서는 IP 주소가 필요
   - IP가 없는 VM은 수동으로 입력 필요

2. **SSH 접근 필요**
   - 모든 작업은 SSH를 통해 수행
   - 올바른 SSH 키 선택 필수

3. **설치 순서**
   - Node Exporter가 먼저 설치됨
   - Node Exporter 설치 실패 시 Promtail 설치 중단

4. **전원 상태**
   - VM이 켜져 있어야 IP 조회 가능
   - 전원이 꺼진 VM은 IP 조회 실패 가능





