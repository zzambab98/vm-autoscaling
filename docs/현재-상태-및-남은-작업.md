# VM 오토스케일링 프로젝트 현재 상태 및 남은 작업

**작성일**: 2025-11-25  
**최종 수정일**: 2025-12-11  
**프로젝트**: VM-Autoscaling

---

## 📊 전체 진행 상황

### ✅ 완료된 Phase

#### Phase 1: 템플릿 관리 시스템 ✅
- **백엔드 API**: 완료
  - ✅ 템플릿 생성 API (`POST /api/templates`)
  - ✅ 템플릿 목록 조회 API (`GET /api/templates`)
  - ✅ 템플릿 상세 조회 API (`GET /api/templates/:id`)
  - ✅ 템플릿 삭제 API (`DELETE /api/templates/:id`)
  - ✅ vCenter API 연동 (VM → Template 변환)
  - ✅ VM 목록 조회 API (`GET /api/templates/vms`)

- **프론트엔드 UI**: 완료
  - ✅ 템플릿 목록 화면 (`TemplateList.jsx`)
  - ✅ 템플릿 생성 화면 (`TemplateForm.jsx`)

- **데이터 저장소**: 완료
  - ✅ 템플릿 메타데이터 저장 (`backend/data/templates.json`)

#### Phase 2: 오토스케일링 설정 시스템 ✅
- **백엔드 API**: 완료
  - ✅ 설정 생성 API (`POST /api/autoscaling/configs`)
  - ✅ 설정 목록 조회 API (`GET /api/autoscaling/configs`)
  - ✅ 설정 상세 조회 API (`GET /api/autoscaling/configs/:id`)
  - ✅ 설정 수정 API (`PUT /api/autoscaling/configs/:id`)
  - ✅ 설정 삭제 API (`DELETE /api/autoscaling/configs/:id`)
  - ✅ 활성화/비활성화 API (`POST /api/autoscaling/configs/:id/enable`, `disable`)
  - ✅ 설정 검증 로직

- **프론트엔드 UI**: 완료
  - ✅ 설정 목록 화면 (`AutoscalingConfigList.jsx`)
  - ✅ 설정 생성/수정 화면 (`AutoscalingConfigForm.jsx`)

- **데이터 저장소**: 완료
  - ✅ 설정 저장 (`backend/data/autoscaling-configs.json`)

#### Phase 3: PLG Stack 연동 ✅
- **Prometheus 연동**: 완료
  - ✅ Alert Rule 생성/삭제 (`prometheusAlertService.js`)
  - ✅ Prometheus Job 추가 (`prometheusMonitoringService.js`)
  - ✅ SSH 연동 및 설정 파일 수정
  - ✅ Prometheus 컨테이너 재시작

- **Alertmanager 연동**: 완료
  - ✅ 라우팅 규칙 추가/삭제 (`alertmanagerService.js`)
  - ✅ Webhook 수신자 추가
  - ✅ Alertmanager 컨테이너 재시작

#### Phase 4: Jenkins 파이프라인 구현 ✅
- **Jenkins Job 자동 생성**: 완료
  - ✅ Jenkins Job 생성 API (`jenkinsService.js`)
  - ✅ Job XML 생성 로직
  - ✅ Generic Webhook Trigger 설정
  - ✅ SSH 키 경로 파라미터 추가 (`SSH_KEY_PATH`)
  - ✅ VM Prefix 파라미터 추가 (`VM_PREFIX`)

- **자동 스케일아웃 파이프라인**: 완료
  - ✅ Jenkinsfile 작성 (`jenkins/Jenkinsfile.autoscale.linux`)
  - ✅ Webhook 파라미터 파싱
  - ✅ IP Pool 관리 (`scripts/get-available-ip.py`)
  - ✅ VM 생성 Stage (타임스탬프 기반 이름 생성)
  - ✅ VM IP 설정 Stage (SSH를 통한 Netplan 설정)
  - ✅ F5 Pool 추가 Stage
  - ✅ 에러 처리 및 롤백

- **자동 스케일인 파이프라인**: 완료
  - ✅ Jenkinsfile 작성 (`jenkins/Jenkinsfile.autoscale-in`)
  - ✅ VM Prefix 기반 VM 선택
  - ✅ 타임스탬프 기준 정렬 (가장 오래된 VM부터 제거)
  - ✅ F5 Pool에서 제거
  - ✅ 모니터링 제거 (Node Exporter/Promtail)
  - ✅ Prometheus Job에서 제거
  - ✅ vCenter에서 VM 삭제

### ⚠️ 부분 완료된 Phase

#### Phase 5: Frontend UI 구현 (부분 완료)

**완료된 작업**:
- ✅ 모니터링 대시보드 컴포넌트 (`MonitoringDashboard.jsx`)
  - ✅ CPU/Memory 그래프 (Recharts 사용)
  - ✅ 실시간 메트릭 조회
  - ✅ 알림 목록 표시 (Alertmanager API 연동)
  - ✅ Alert 상태 필터링 (`active`, `firing` 상태 표시)
- ✅ 스케일아웃 이벤트 목록 컴포넌트 (`ScaleOutEventList.jsx`)
  - ✅ 이벤트 목록 테이블
  - ✅ 이벤트 필터링 (서비스별, 상태별)
- ✅ 오토스케일링 설정 폼 개선 (`AutoscalingConfigForm.jsx`)
  - ✅ SSH 키 선택 드롭다운 추가
  - ✅ VM 이름 Prefix 입력 필드 추가
  - ✅ 스케일아웃/스케일인 조건 표시

**미완료 작업**:
- ❌ 스케일아웃 이벤트 상세 화면 (`ScaleOutEventDetail.jsx`)
- ❌ 스케일아웃 이벤트 저장/조회 API (백엔드)
- ❌ Jenkins 빌드 이력 상세 조회 API
- ❌ 이벤트 저장 로직 (Webhook에서)

### ❌ 미완료된 Phase

#### Phase 6: 통합 테스트 및 배포
- ❌ 전체 워크플로우 통합 테스트
- ❌ 에러 시나리오 테스트
- ❌ 성능 테스트
- ❌ 사용자 가이드 작성
- ❌ 운영 가이드 작성
- ❌ API 문서 작성
- ❌ 배포 스크립트 작성

---

## 🔧 남은 작업 상세

### 1. 스케일아웃 이벤트 저장/조회 시스템

#### 1.1 백엔드 API 구현 필요

**파일**: `backend/src/services/scaleOutEventService.js` (신규 생성)

**필요한 기능**:
- [ ] `saveEvent(eventData)` - 이벤트 저장
- [ ] `getEvents(filters)` - 이벤트 목록 조회
- [ ] `getEventById(eventId)` - 이벤트 상세 조회
- [ ] `updateEventStatus(eventId, status)` - 이벤트 상태 업데이트

**데이터 저장소**: `backend/data/scale-out-events.json`

**API 엔드포인트**:
- [ ] `POST /api/autoscaling/events` - 이벤트 저장
- [ ] `GET /api/autoscaling/events` - 이벤트 목록 조회 (필터링 지원)
- [ ] `GET /api/autoscaling/events/:id` - 이벤트 상세 조회

#### 1.2 Webhook 엔드포인트 수정

**파일**: `backend/src/server.js` (기존 `/api/webhook/autoscale/:serviceName` 수정)

**필요한 작업**:
- [ ] Alertmanager에서 받은 Webhook 데이터 파싱
- [ ] 오토스케일링 설정 조회
- [ ] 스케일아웃 이벤트 생성 및 저장
- [ ] Jenkins Job 트리거 시 이벤트 ID 전달
- [ ] Jenkins 파이프라인 완료 후 이벤트 상태 업데이트

#### 1.3 Jenkins 파이프라인 연동

**파일**: `jenkins/Jenkinsfile.autoscale` (수정)

**필요한 작업**:
- [ ] 파이프라인 시작 시 이벤트 ID를 백엔드에 전달하여 상태 업데이트
- [ ] 각 Stage 완료 시 이벤트 액션 기록
- [ ] 파이프라인 완료 시 최종 상태 업데이트

### 2. 스케일아웃 이벤트 상세 화면

#### 2.1 프론트엔드 컴포넌트

**파일**: `frontend/src/components/ScaleOutEventDetail.jsx` (신규 생성)

**필요한 기능**:
- [ ] 이벤트 정보 표시 (ID, 서비스, 트리거, 상태, 시간)
- [ ] 작업 내역 표시 (VM 생성, IP 할당, F5 추가 등)
- [ ] Jenkins 파이프라인 로그 링크
- [ ] 실시간 상태 업데이트

#### 2.2 이벤트 목록 개선

**파일**: `frontend/src/components/ScaleOutEventList.jsx` (수정)

**필요한 작업**:
- [ ] 실제 이벤트 API 호출로 변경 (현재는 Jenkins Job 목록만 조회)
- [ ] 이벤트 상세 보기 버튼 클릭 시 상세 화면으로 이동
- [ ] 날짜별 필터링 추가
- [ ] 빌드 번호 및 상세 정보 표시

### 3. Jenkins 빌드 이력 조회 API

#### 3.1 백엔드 API 추가

**파일**: `backend/src/services/jenkinsService.js` (수정)

**필요한 기능**:
- [ ] `getJobBuilds(jobName, limit)` - Job의 빌드 목록 조회
- [ ] `getBuildDetails(jobName, buildNumber)` - 빌드 상세 정보 조회
- [ ] `getBuildLog(jobName, buildNumber)` - 빌드 로그 조회

**API 엔드포인트**:
- [ ] `GET /api/jenkins/jobs/:jobName/builds` - 빌드 목록 조회
- [ ] `GET /api/jenkins/jobs/:jobName/builds/:buildNumber` - 빌드 상세 조회
- [ ] `GET /api/jenkins/jobs/:jobName/builds/:buildNumber/log` - 빌드 로그 조회

### 4. IP Pool 관리 스크립트

#### 4.1 Python 스크립트

**파일**: `scripts/get-available-ip.py` (확인 필요)

**필요한 기능**:
- [ ] IP 범위 검증
- [ ] Ping 테스트를 통한 사용 가능한 IP 찾기
- [ ] 사용 중인 IP 추적 (선택사항)

**현재 상태**: 파일 존재 여부 확인 필요

### 5. 통합 테스트

#### 5.1 전체 워크플로우 테스트

**테스트 시나리오**:
- [ ] 템플릿 생성 테스트
- [ ] 오토스케일링 설정 생성 및 활성화 테스트
- [ ] Prometheus Alert Rule 생성 확인
- [ ] Alertmanager 라우팅 규칙 추가 확인
- [ ] Jenkins Job 생성 확인
- [ ] 수동 Webhook 트리거 테스트
- [ ] Jenkins 파이프라인 실행 테스트
- [ ] VM 생성 확인
- [ ] F5 Pool Member 추가 확인

#### 5.2 에러 시나리오 테스트

**테스트 시나리오**:
- [ ] 템플릿 없음 에러 처리
- [ ] IP Pool 부족 에러 처리
- [ ] F5 연결 실패 에러 처리
- [ ] Jenkins 파이프라인 실패 시 롤백
- [ ] VM 생성 실패 시 정리

#### 5.3 동시 실행 테스트

**테스트 시나리오**:
- [ ] 여러 서비스 동시 스케일아웃
- [ ] 동일 서비스 중복 스케일아웃 요청 처리

### 6. 문서화

#### 6.1 사용자 가이드

**파일**: `docs/사용자-가이드.md` (확인 필요)

**필요한 내용**:
- [ ] 시스템 개요
- [ ] 템플릿 생성 가이드
- [ ] 오토스케일링 설정 가이드
- [ ] 모니터링 대시보드 사용법
- [ ] 스케일아웃 이벤트 확인 방법

#### 6.2 운영 가이드

**파일**: `docs/운영-가이드.md` (신규 생성)

**필요한 내용**:
- [ ] 시스템 배포 방법
- [ ] 환경 변수 설정
- [ ] 트러블슈팅 가이드
- [ ] 모니터링 및 알림 설정
- [ ] 백업 및 복구 방법

#### 6.3 API 문서

**파일**: `docs/API-참조.md` (신규 생성)

**필요한 내용**:
- [ ] 모든 API 엔드포인트 목록
- [ ] 요청/응답 형식
- [ ] 에러 코드 및 메시지
- [ ] 인증 방법

---

## 📝 우선순위별 작업 계획

### 🔴 높은 우선순위 (즉시 필요)

1. **스케일아웃 이벤트 저장/조회 시스템**
   - 백엔드 서비스 구현
   - API 엔드포인트 추가
   - Webhook 엔드포인트 수정
   - 예상 소요 시간: 2-3일

2. **Jenkins 빌드 이력 조회 API**
   - Jenkins API 연동
   - 빌드 상세 정보 조회
   - 예상 소요 시간: 1일

3. **스케일아웃 이벤트 상세 화면**
   - 프론트엔드 컴포넌트 생성
   - 이벤트 목록 개선
   - 예상 소요 시간: 1-2일

### 🟡 중간 우선순위 (단기 필요)

4. **IP Pool 관리 스크립트 확인/개선**
   - 스크립트 존재 여부 확인
   - 기능 테스트 및 개선
   - 예상 소요 시간: 0.5일

5. **통합 테스트**
   - 전체 워크플로우 테스트
   - 에러 시나리오 테스트
   - 예상 소요 시간: 2-3일

### 🟢 낮은 우선순위 (장기 필요)

6. **문서화**
   - 사용자 가이드 보완
   - 운영 가이드 작성
   - API 문서 작성
   - 예상 소요 시간: 2-3일

---

## 📌 참고 사항

### 현재 구현된 주요 기능

1. **템플릿 관리**: 완전 자동화
   - VM을 템플릿으로 변환
   - 템플릿 메타데이터 관리

2. **오토스케일링 설정**: 완전 자동화
   - 설정 생성 시 자동으로:
     - Prometheus Alert Rule 생성
     - Alertmanager 라우팅 규칙 추가
     - Jenkins Job 생성

3. **PLG Stack 연동**: 완전 자동화
   - SSH를 통한 설정 파일 수정
   - 컨테이너 자동 재시작

4. **Jenkins 파이프라인**: 기본 구조 완성
   - Webhook 파라미터 파싱
   - VM 생성 및 F5 연동

### 알려진 이슈

1. **스케일아웃 이벤트 추적**: 현재 Webhook에서 이벤트를 저장하지 않음
2. **Jenkins 빌드 이력**: 상세 정보 조회 API 없음
3. **이벤트 상세 화면**: 컴포넌트 미구현

### 최근 작업 내역 (2025-12-03)

#### ✅ 완료된 작업

1. **SSH 키 선택 기능 추가**
   - Frontend: SSH 키 드롭다운 추가 (`AutoscalingConfigForm.jsx`)
   - Backend: `/api/ssh-keys` 엔드포인트 추가
   - Jenkins Job XML: `SSH_KEY_PATH` 파라미터 추가
   - Jenkinsfile: 설정에서 지정한 SSH 키 우선 사용, Fallback 로직 추가

2. **VM 이름 타임스탬프 기반 변경**
   - Frontend: VM Prefix 입력 필드 추가
   - Backend: `VM_PREFIX` 파라미터 추가 (스케일아웃/스케일인 모두)
   - Jenkinsfile (autoscale.linux): 타임스탬프 기반 이름 생성 (`prefix-YYYYMMDDHHmm`)
   - Jenkinsfile (autoscale-in): vmPrefix로 필터링하여 가장 오래된 VM부터 제거
   - 중복 방지: 타임스탬프 사용으로 절대 중복 불가

3. **Alert 표시 문제 수정**
   - Backend: Alertmanager API 프록시 추가 (`/api/alerts`)
   - Frontend: `active` 상태 알림도 표시하도록 필터링 개선
   - Alertmanager의 `active` 상태를 `firing`으로 표시

4. **Webhook Payload 수정**
   - `server.js`에 `vmPrefix`와 `sshKeyPath` 추가 완료

5. **VM IP 설정 개선**
   - `govc vm.customize`의 `-hostname` 플래그 제거 (지원하지 않음)
   - VM 부팅 후 SSH를 통한 Netplan 설정 단계 추가
   - 할당된 IP와 실제 IP가 다를 경우 자동으로 Netplan 설정

#### ✅ 조치 완료된 문제 (2025-12-03)

1. **SSH 키 경로 전달 문제** ✅
   - 증상: Jenkins Console에서 `env.SSH_KEY_PATH`가 비어있음
   - 원인: Generic Webhook Trigger 변수 대신 백엔드 API에서 직접 조회 필요
   - 조치 완료:
     - ✅ Jenkinsfile의 "Get Autoscaling Config" 단계에서 백엔드 API 응답의 `sshKeyPath`를 환경 변수로 설정
     - ✅ `env.SSH_KEY_PATH = configData.sshKeyPath ?: ''` 추가
     - ✅ 디버깅 로그 추가로 경로 확인 가능

2. **Fallback SSH 키 검색 실패** ✅
   - 증상: Jenkins 서버에서 절대 경로 접근 불가
   - 원인: Jenkins 서버와 백엔드 서버의 경로 차이
   - 조치 완료:
     - ✅ 여러 가능한 경로에서 SSH 키 검색하도록 개선
     - ✅ Jenkins 워크스페이스 기준 상대 경로 시도
     - ✅ 파일명만 추출하여 여러 위치에서 검색
     - ✅ Fallback 키 검색도 여러 경로에서 시도

#### 🔧 조치 내용 상세

1. **백엔드 API에서 SSH 키 경로 조회**
   - Jenkinsfile의 "Get Autoscaling Config" 단계에서 백엔드 API 응답의 `sshKeyPath`와 `vmPrefix`를 환경 변수로 설정
   - Generic Webhook Trigger 변수에 의존하지 않고 백엔드 API에서 직접 가져옴

2. **SSH 키 경로 다중 검색 로직**
   - 설정에서 지정한 경로를 여러 가능한 위치에서 검색:
     - 절대 경로 그대로 시도
     - Jenkins 워크스페이스 기준 상대 경로 (`$WORKSPACE/pemkey/`)
     - 파일명만 추출하여 여러 위치에서 검색
   - Fallback 키 검색도 여러 경로에서 시도:
     - `$WORKSPACE/pemkey/`
     - `/home/ubuntu/workspace/vm-autoscaling/pemkey/`
     - `/var/lib/jenkins/workspace/vm-autoscaling/pemkey/`

3. **디버깅 로그 추가**
   - `env.SSH_KEY_PATH`와 `WORKSPACE` 환경 변수 확인 로그 추가
   - 각 경로 검색 결과 로그 출력

### ✅ 백엔드-vCenter 통신 문제 해결 (2025-12-05)

**문제**: `start-services.sh` 실행 시 백엔드가 vCenter와 통신하지 못함

**원인**:
- `start-services.sh`에서 환경 변수를 export했지만, `run-dev.sh`가 이를 제대로 상속받지 못함
- `run-dev.sh`에서 환경 변수 우선순위 처리 로직이 불완전함

**해결 방법**:
1. **`run-dev.sh` 환경 변수 처리 개선**
   - `GOVC_*` 환경 변수를 우선적으로 사용하도록 수정
   - `VCENTER_*` 환경 변수도 하위 호환성을 위해 설정
   - 백엔드 실행 시 모든 vCenter 관련 환경 변수를 명시적으로 전달

2. **환경 변수 전달 명확화**
   - 백엔드 실행 시 `GOVC_URL`, `GOVC_USERNAME`, `GOVC_PASSWORD`, `GOVC_INSECURE` 명시적 전달
   - `VCENTER_URL`, `VCENTER_USERNAME`, `VCENTER_PASSWORD`도 함께 전달하여 이중 보장
   - 디버깅을 위한 환경 변수 출력 로그 추가

**결과**:
- ✅ 백엔드가 vCenter에 정상 연결됨
- ✅ 템플릿 목록 조회 API (`GET /api/templates`) 정상 작동
- ✅ vCenter에서 템플릿 목록을 정상적으로 가져옴

### ✅ vCenter 연결 안정성 개선 (2025-12-08)

**문제**: nodemon 재시작 시 환경 변수가 유지되지 않아 vCenter 연결이 끊어짐

**원인**:
1. **환경 변수 로드 시점 문제**: `templateService.js`에서 모듈 로드 시점에 환경 변수를 읽어서, nodemon이 재시작할 때 환경 변수가 없으면 `undefined`가 됨
2. **nodemon 환경 변수 미전달**: nodemon이 파일 변경을 감지하고 재시작할 때 환경 변수가 전달되지 않음
3. **중복 프로세스**: 여러 nodemon 프로세스가 실행되어 포트 충돌 발생

**해결 방법**:
1. **`nodemon.json` 생성**
   - nodemon 재시작 시에도 환경 변수가 유지되도록 설정 파일 생성
   - 모든 vCenter, F5, Prometheus, Jenkins 관련 환경 변수를 명시적으로 설정

2. **환경 변수 런타임 로드**
   - `templateService.js`에서 환경 변수를 모듈 로드 시점이 아닌 함수 호출 시점에 읽도록 변경
   - `getVCenterConfig()` 함수를 추가하여 중앙화된 환경 변수 관리
   - 모든 vCenter 관련 함수에서 `getVCenterConfig()`를 사용하도록 수정

3. **프로세스 관리 개선**
   - `stop-dev.sh`에서 모든 nodemon 프로세스를 종료하도록 개선
   - 포트 기반 프로세스 종료 로직 강화

**결과**:
- ✅ nodemon 재시작 시에도 vCenter 연결 정보가 유지됨
- ✅ 환경 변수가 런타임에 읽혀서 항상 최신 값 사용
- ✅ 중복 프로세스 문제 해결
- ✅ vCenter 연결 안정성 대폭 개선

---

## 🎯 다음 단계

1. **즉시 시작 가능한 작업**:
   - 스케일아웃 이벤트 서비스 구현
   - Webhook 엔드포인트 수정
   - 이벤트 상세 화면 구현

2. **테스트 준비**:
   - 전체 워크플로우 테스트 시나리오 작성
   - 테스트 환경 준비

3. **문서화**:
   - 사용자 가이드 보완
   - 운영 가이드 작성

---

**작성자**: AI Assistant  
**최종 수정일**: 2025-12-11

---

## 📚 관련 문서

- [작업 이력 및 개선사항](./작업-이력-및-개선사항.md) - 상세한 작업 내역 및 개선사항

