// Jenkins Pipeline í†µí•© ìŠ¤í¬ë¦½íŠ¸ (Linux í™˜ê²½ìš© - govc ì‚¬ìš©)
// Alertmanager Webhook â†’ Jenkins â†’ vCenter API (govc) â†’ F5 Pool ìë™ ë“±ë¡ íŒŒì´í”„ë¼ì¸
// Job ì´ë¦„: plg-autoscale-out

pipeline {
    agent any
    
    // Generic Webhook Trigger ì„¤ì •
    triggers {
        GenericTrigger(
            genericVariables: [
                // Alertmanagerì—ì„œ ì „ë‹¬ë˜ëŠ” ë°ì´í„° íŒŒì‹±
                [key: 'alertname', value: '$.alerts[0].labels.alertname', regexpFilter: ''],
                [key: 'instance', value: '$.alerts[0].labels.instance', regexpFilter: ''],
                [key: 'service', value: '$.alerts[0].labels.service', regexpFilter: ''],
                [key: 'autoscaleConfigId', value: '$.alerts[0].labels.autoscaleConfigId', regexpFilter: ''],
                [key: 'severity', value: '$.alerts[0].labels.severity', regexpFilter: ''],
                [key: 'status', value: '$.status', regexpFilter: ''],
                [key: 'summary', value: '$.alerts[0].annotations.summary', regexpFilter: ''],
                [key: 'description', value: '$.alerts[0].annotations.description', regexpFilter: '']
            ],
            causeString: 'Alert: $alertname - Service: $service - Instance: $instance',
            token: 'plg-autoscale-token',
            printContributedVariables: true,
            printPostContent: true,
            // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ (firingë§Œ ì²˜ë¦¬)
            regexpFilterText: '$status',
            regexpFilterExpression: '^firing$'
        )
    }
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // vCenter ì„¤ì • (Jenkins Credentials ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…)
        GOVC_URL = ''
        GOVC_USERNAME = ''
        GOVC_PASSWORD = ''
        GOVC_INSECURE = '1'  // SSL ì¸ì¦ì„œ ê²€ì¦ ë¹„í™œì„±í™”
        
        // ê¸°ë³¸ vCenter ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        VCENTER_RESOURCE_POOL = 'APP-RP'
        VCENTER_DATASTORE = 'OS-Datastore-Power-Store'
        
        // F5 ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        F5_SERVER = '10.255.1.80'
        F5_PARTITION = 'Common'
        F5_HEALTH_MONITOR = '/Common/http'
        F5_USERNAME = ''
        F5_PASSWORD = ''
        
        // ë°±ì—”ë“œ API URL (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒìš©)
        BACKEND_API_URL = 'http://10.255.48.253:6010'
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        VM_IP_TIMEOUT = '300'  // 5ë¶„
    }
    
    stages {
        // Stage 1: Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦
        stage('Parse Alert') {
            steps {
                script {
                    echo "=========================================="
                    echo "Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦"
                    echo "=========================================="
                    
                    def alertname = env.alertname ?: 'Unknown'
                    def instance = env.instance ?: 'all'
                    def service = env.service ?: 'unknown'
                    def autoscaleConfigId = env.autoscaleConfigId ?: ''
                    def severity = env.severity ?: 'warning'
                    def status = env.status ?: 'unknown'
                    def summary = env.summary ?: ''
                    def description = env.description ?: ''
                    
                    echo "Alert Name: ${alertname}"
                    echo "Service: ${service}"
                    echo "Instance: ${instance}"
                    echo "Autoscale Config ID: ${autoscaleConfigId}"
                    echo "Severity: ${severity}"
                    echo "Status: ${status}"
                    echo "Summary: ${summary}"
                    echo "Description: ${description}"
                    
                    // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ
                    if (status != 'firing') {
                        echo "Alert status is '${status}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Critical ë˜ëŠ” Warning ì•Œë¦¼ë§Œ ì²˜ë¦¬
                    if (severity != 'critical' && severity != 'warning') {
                        echo "Alert severity is '${severity}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Autoscale Config IDê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜
                    if (!autoscaleConfigId) {
                        error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤. Alert Rule ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
                    }
                    
                    // í™˜ê²½ ë³€ìˆ˜ ì €ì¥
                    env.VM_INSTANCE = instance
                    env.ALERT_SERVICE = service
                    env.ALERT_SEVERITY = severity
                    env.AUTOSCALE_CONFIG_ID = autoscaleConfigId
                    
                    echo "Alert íŒŒì‹± ì™„ë£Œ. ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì¤‘..."
                }
            }
        }
        
        // Stage 2: ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ
        stage('Get Autoscaling Config') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED'),
                        usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME_CRED', passwordVariable: 'F5_PASSWORD_CRED')
                    ]) {
                        echo "=========================================="
                        echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ"
                       	echo "=========================================="
                        
                        if (!env.GOVC_URL || env.GOVC_URL.trim() == '') {
                            env.GOVC_URL = VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        }
                        if (!env.GOVC_USERNAME || env.GOVC_USERNAME.trim() == '') {
                            env.GOVC_USERNAME = VCENTER_USER_CRED ?: 'svc-auto'
                        }
                        if (!env.GOVC_PASSWORD || env.GOVC_PASSWORD.trim() == '') {
                            if (VCENTER_PASSWORD_CRED && VCENTER_PASSWORD_CRED.trim() != '') {
                                env.GOVC_PASSWORD = VCENTER_PASSWORD_CRED
                            } else {
                                error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Jenkins Credentials 'vcenter-password'ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                            }
                        }
                        
                        env.F5_USERNAME = F5_USERNAME_CRED ?: env.F5_USERNAME
                        env.F5_PASSWORD = F5_PASSWORD_CRED ?: env.F5_PASSWORD
                        
                        def configId = env.AUTOSCALE_CONFIG_ID
                        if (!configId || configId.trim() == '') {
                            error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            echo "ë°±ì—”ë“œ API í˜¸ì¶œ: ${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}"
                            def configResponseText = sh(
                                script: """curl -sf -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}" """,
                                returnStdout: true
                            ).trim()
                            
                            def configResponse = new groovy.json.JsonSlurper().parseText(configResponseText)
                            def configData = configResponse.config ?: configResponse
                            
                            // ë””ë²„ê¹…: vCenter ì •ë³´ í™•ì¸
                            echo "ë””ë²„ê¹…: configData.vcenter = ${configData.vcenter}"
                            if (configData.vcenter) {
                                echo "ë””ë²„ê¹…: vcenter.resourcePool = ${configData.vcenter.resourcePool}"
                                echo "ë””ë²„ê¹…: vcenter.datastore = ${configData.vcenter.datastore}"
                            }
                            
                            if (!configData.serviceName) {
                                error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${configResponseText}")
                            }
                            
                            if (configData.templateId) {
                                echo "ğŸ“ Template ì •ë³´ ì¡°íšŒ: ${configData.templateId}"
                                try {
                                    def templateResponseText = sh(
                                        script: """curl -s -w "\\n%{http_code}" -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/templates/${configData.templateId}" """,
                                        returnStdout: true
                                    ).trim()

                                    def lines = templateResponseText.split('\n')
                                    def httpCode = lines[-1]
                                    def responseBody = lines[0..-2].join('\n')

                                    echo "ğŸ” Template API HTTP ì‘ë‹µ ì½”ë“œ: ${httpCode}"

                                    if (httpCode == '200') {
                                        def templateJson = new groovy.json.JsonSlurper().parseText(responseBody)
                                        def templateName = templateJson.template?.name ?: templateJson.name

                                        if (templateName && templateName != '' && templateName != 'null') {
                                            env.VCENTER_TEMPLATE = templateName
                                            echo "âœ… Template ì´ë¦„: ${env.VCENTER_TEMPLATE}"
                                        } else {
                                            echo "âš ï¸ Template ì´ë¦„ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                            env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                        }
                                    } else {
                                        echo "âš ï¸ Template API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ${httpCode}). ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                        env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                    }
                                } catch (Exception tmplErr) {
                                    echo "âš ï¸ Template ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ: ${tmplErr.class.name}"
                                    echo "ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                    env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                }
                            } else {
                                echo "âš ï¸ templateIdê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                            }
                            
                            // VM ì´ë¦„ ìƒì„±: ê¸°ì¡´ VM ëª©ë¡ í™•ì¸ í›„ ë‹¤ìŒ ìˆœì°¨ ë²ˆí˜¸ ìƒì„±
                            def serviceName = configData.serviceName ?: 'app'
                            def serviceNameClean = serviceName.toLowerCase().replaceAll(/[^a-z0-9-]/, '-')

                            // serviceNameì—ì„œ ì ‘ë¯¸ì‚¬ ì œê±° (ì˜ˆ: auto-vm-test-service -> auto-vm-test)
                            def parts = serviceNameClean.split('-')
                            def baseName = serviceNameClean
                            if (parts.size() > 1) {
                                def lastPart = parts[-1]
                                if (lastPart in ['service', 'job', 'app', 'api', 'web']) {
                                    baseName = parts[0..-2].join('-')
                                }
                            }

                            echo "ì„œë¹„ìŠ¤ ì´ë¦„: ${serviceNameClean}"
                            echo "ê¸°ë³¸ ì´ë¦„: ${baseName}"

                            // VM Prefix ê²°ì • (ì‚¬ìš©ì ì§€ì • ë˜ëŠ” ê¸°ë³¸ê°’)
                            def vmPrefix = env.VM_PREFIX ?: baseName
                            echo "VM Prefix: ${vmPrefix}"

                            // VM ì´ë¦„ ìƒì„± (prefix-íƒ€ì„ìŠ¤íƒ¬í”„ í˜•ì‹: prefix-YYYYMMDDHHmm)
                            def timestamp = new Date().format('yyyyMMddHHmm')
                            env.NEW_VM_NAME = "${vmPrefix}-${timestamp}"
                            env.VM_HOSTNAME = env.NEW_VM_NAME  // í˜¸ìŠ¤íŠ¸ë„¤ì„ë„ ë™ì¼í•˜ê²Œ ì„¤ì •

                            echo "ìƒì„±í•  VM ì´ë¦„: ${env.NEW_VM_NAME}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME}"
                            echo "íƒ€ì„ìŠ¤íƒ¬í”„: ${timestamp}"
                            
                            env.IP_POOL_START = configData.network?.ipPoolStart ?: ''
                            env.IP_POOL_END = configData.network?.ipPoolEnd ?: ''
                            env.SUBNET = configData.network?.subnet ?: '255.255.255.0'
                            env.GATEWAY = configData.network?.gateway ?: ''
                            env.VLAN = configData.network?.vlan ?: ''
                            
                            env.F5_POOL_NAME = configData.f5?.poolName ?: ''
                            env.F5_POOL_PORT = configData.f5?.vipPort ?: '80'
                            env.F5_VIP = configData.f5?.vip ?: ''
                            env.F5_HEALTH_CHECK_PATH = configData.f5?.healthCheckPath ?: '/'
                            
                            // SSH í‚¤ ê²½ë¡œ ë° VM Prefix ì„¤ì • (ë°±ì—”ë“œ APIì—ì„œ ì¡°íšŒ)
                            env.SSH_KEY_PATH = configData.sshKeyPath ?: ''
                            env.VM_PREFIX = configData.vmPrefix ?: ''
                            echo "SSH í‚¤ ê²½ë¡œ: ${env.SSH_KEY_PATH ?: 'ë¯¸ì§€ì • (Fallback ì‚¬ìš©)'}"
                            echo "VM Prefix: ${env.VM_PREFIX ?: 'ë¯¸ì§€ì • (ê¸°ë³¸ê°’ ì‚¬ìš©)'}"
                            
                            // vCenter ì •ë³´ ì„¤ì • (LazyMap ì§ì ‘ ì ‘ê·¼)
                            def vcenterInfo = configData.vcenter
                            def vcenterResourcePool = null
                            def vcenterDatastore = null
                            
                            if (vcenterInfo) {
                                // LazyMapì—ì„œ ì§ì ‘ ê°’ ê°€ì ¸ì˜¤ê¸°
                                vcenterResourcePool = vcenterInfo.get('resourcePool')
                                vcenterDatastore = vcenterInfo.get('datastore')
                                echo "ë””ë²„ê¹…: vcenterInfoì—ì„œ ì¶”ì¶œ - resourcePool=${vcenterResourcePool}, datastore=${vcenterDatastore}"
                            }
                            
                            // vCenter ì„¤ì •ì„ ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¡œ ì €ì¥ (í™˜ê²½ ë³€ìˆ˜ëŠ” ë³€ê²½ ë¶ˆê°€)
                            def finalResourcePool = vcenterResourcePool?.toString()?.trim()
                            if (!finalResourcePool || finalResourcePool == '' || finalResourcePool == 'null') {
                                finalResourcePool = env.VCENTER_RESOURCE_POOL
                                echo "âš  vCenter Resource Pool: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalResourcePool})"
                            } else {
                                echo "âœ“ vCenter Resource Pool: ${finalResourcePool}"
                            }

                            def finalDatastore = vcenterDatastore?.toString()?.trim()
                            if (!finalDatastore || finalDatastore == '' || finalDatastore == 'null') {
                                finalDatastore = env.VCENTER_DATASTORE
                                echo "âš  vCenter Datastore: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalDatastore})"
                            } else {
                                echo "âœ“ vCenter Datastore: ${finalDatastore}"
                            }

                            // ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ë„ ì €ì¥ (ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œ ì‚¬ìš©)
                            env.FINAL_RESOURCE_POOL = finalResourcePool
                            env.FINAL_DATASTORE = finalDatastore
                            
                            echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì™„ë£Œ:"
                            echo "  Template: ${env.VCENTER_TEMPLATE}"
                            echo "  VM Name: ${env.NEW_VM_NAME}"
                            echo "  IP Pool: ${env.IP_POOL_START} - ${env.IP_POOL_END}"
                            echo "  F5 Pool: ${env.F5_POOL_NAME}"
                            echo "  F5 VIP: ${env.F5_VIP}"
                            echo "  Resource Pool: ${finalResourcePool}"
                            echo "  Datastore: ${finalDatastore}"
                            
                        } catch (Exception e) {
                            error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 3: IP ì£¼ì†Œ í• ë‹¹
        stage('Allocate IP Address') {
            steps {
                script {
                    echo "=========================================="
                    echo "IP ì£¼ì†Œ í• ë‹¹"
                    echo "=========================================="
                    
                    def ipStart = env.IP_POOL_START
                    def ipEnd = env.IP_POOL_END
                    
                    if (!ipStart || !ipEnd) {
                        error("IP Poolì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // IP Poolì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸°
                    // ê°„ë‹¨í•œ ë°©ë²•: IP Pool ë²”ìœ„ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸
                    def allocatedIP = ''
                    
                    // IP ì£¼ì†Œë¥¼ ìˆ«ìë¡œ ë³€í™˜
                    def ipStartParts = ipStart.split('\\.')
                    def ipEndParts = ipEnd.split('\\.')
                    
                    def startLong = ipStartParts[0].toLong() * 256 * 256 * 256 +
                                   ipStartParts[1].toLong() * 256 * 256 +
                                   ipStartParts[2].toLong() * 256 +
                                   ipStartParts[3].toLong()
                    
                    def endLong = ipEndParts[0].toLong() * 256 * 256 * 256 +
                                 ipEndParts[1].toLong() * 256 * 256 +
                                 ipEndParts[2].toLong() * 256 +
                                 ipEndParts[3].toLong()
                    
                    // IP Pool ë²”ìœ„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸° (ping í…ŒìŠ¤íŠ¸)
                    for (long ip = startLong; ip <= endLong; ip++) {
                        // ìˆ«ìë¥¼ IPë¡œ ë³€í™˜
                        def octet1 = (ip >> 24) & 0xFF
                        def octet2 = (ip >> 16) & 0xFF
                        def octet3 = (ip >> 8) & 0xFF
                        def octet4 = ip & 0xFF
                        def testIP = "${octet1}.${octet2}.${octet3}.${octet4}"
                        
                        // pingìœ¼ë¡œ IP ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                        def pingResult = sh(
                            script: "ping -c 1 -W 1 ${testIP} > /dev/null 2>&1",
                            returnStatus: true
                        )
                        
                        if (pingResult != 0) {
                            // ping ì‹¤íŒ¨ = IP ì‚¬ìš© ê°€ëŠ¥
                            allocatedIP = testIP
                            break
                        }
                    }
                    
                    if (!allocatedIP) {
                        error("IP Pool (${ipStart} - ${ipEnd})ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IPë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    }
                    
                    env.NEW_VM_IP = allocatedIP
                    echo "IP ì£¼ì†Œ í• ë‹¹ ì™„ë£Œ: ${env.NEW_VM_IP}"
                }
            }
        }
        
        // Stage 4: vCenter VM í´ë¡  (govc ì‚¬ìš©)
        stage('VM Clone') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED')
                    ]) {
                        echo "=========================================="
                        echo "vCenter VM í´ë¡  ì‹œì‘ (govc ì‚¬ìš©)"
                        echo "=========================================="
                        
                        def templateName = env.VCENTER_TEMPLATE
                        def vmName = env.NEW_VM_NAME
                        def vmIP = env.NEW_VM_IP
                        def subnet = env.SUBNET
                        def gateway = env.GATEWAY
                        def vlan = env.VLAN
                        def datastore = env.FINAL_DATASTORE ?: env.VCENTER_DATASTORE
                        def resourcePool = env.FINAL_RESOURCE_POOL ?: env.VCENTER_RESOURCE_POOL
                        
                        // vCenter Credentials ì¬í™•ì¸
                        def govcUrl = env.GOVC_URL ?: VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        def govcUser = env.GOVC_USERNAME ?: VCENTER_USER_CRED ?: 'svc-auto'
                        def govcPass = env.GOVC_PASSWORD ?: VCENTER_PASSWORD_CRED
                        
                        if (!govcPass || govcPass == 'null' || govcPass.trim() == '') {
                            error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            // vCenter Linux Customization Specì„ ì‚¬ìš©í•˜ì—¬ ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IP ì„¤ì •
                            // ë°©ë²•: govc vm.clone ì‹œ -customization ì˜µì…˜ê³¼ GOVC_GUESTINFO_* í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
                            echo "=========================================="
                            echo "vCenter Customization Specìœ¼ë¡œ VM í´ë¡  (ê³ ì • IP ì„¤ì •)..."
                            echo "=========================================="
                            echo "í• ë‹¹ëœ IP: ${vmIP}"
                            echo "ì„œë¸Œë„·: ${subnet}"
                            echo "ê²Œì´íŠ¸ì›¨ì´: ${gateway}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME ?: vmName}"
                            
                            // DNS ì„œë²„ (ê¸°ë³¸ê°’)
                            def dnsServers = '10.255.0.10'
                            
                            // Customization Spec ì´ë¦„ (vCenterì—ì„œ ë¯¸ë¦¬ ìƒì„±í•´ì•¼ í•¨)
                            def customizationSpecName = env.CUSTOMIZATION_SPEC_NAME ?: 'DanaLinuxSpec'
                            
                            // govc ëª…ë ¹ì–´ ì˜µì…˜ êµ¬ì„±
                            def cloneOptions = "-vm=\"${templateName}\" -on=true"  // ë°”ë¡œ ë¶€íŒ…
                            
                            // Customization Spec ì ìš©
                            cloneOptions += " -customization=\"${customizationSpecName}\""
                            
                            // Datastore ì§€ì •
                            if (datastore && datastore != 'null' && datastore.trim() != '') {
                                cloneOptions += " -ds=\"${datastore}\""
                            }
                            
                            // Resource Pool ì§€ì •
                            if (resourcePool && resourcePool != 'null' && resourcePool.trim() != '') {
                                cloneOptions += " -pool=\"${resourcePool}\""
                            }
                            
                            // Network/VLAN ì§€ì •
                            if (vlan && vlan != 'null' && vlan.trim() != '') {
                                cloneOptions += " -net=\"${vlan}\""
                            }
                            
                            // GOVC_GUESTINFO_* í™˜ê²½ ë³€ìˆ˜ë¡œ ê³ ì • IP ì„¤ì •
                            // ì´ë ‡ê²Œ í•˜ë©´ ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IPë¡œ ì˜¬ë¼ì˜´ (DHCP ë‹¨ê³„ ì—†ìŒ)
                            def cloneCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                                # ê³ ì • IP ì„¤ì •ì„ ìœ„í•œ Guest Info í™˜ê²½ ë³€ìˆ˜
                                export GOVC_GUESTINFO_IPADDR="${vmIP}"
                                export GOVC_GUESTINFO_NETMASK="${subnet}"
                                export GOVC_GUESTINFO_GATEWAY="${gateway}"
                                export GOVC_GUESTINFO_DNS="${dnsServers}"
                                
                                # VM í´ë¡  ë° Customization Spec ì ìš©
                                govc vm.clone ${cloneOptions} "${vmName}"
                            """
                            
                            echo "VM í´ë¡  ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘..."
                            echo "Template: ${templateName}"
                            echo "VM Name: ${vmName}"
                            echo "Customization Spec: ${customizationSpecName}"
                            echo "ê³ ì • IP: ${vmIP}"
                            echo "Command: govc vm.clone ${cloneOptions} ${vmName}"
                            
                            def customizationApplied = false
                            try {
                                sh cloneCommand
                                customizationApplied = true
                                echo "âœ… VM í´ë¡  ë° Customization Spec ì ìš© ì™„ë£Œ"
                                echo "âœ… ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IP (${vmIP})ë¡œ ì˜¬ë¼ì˜µë‹ˆë‹¤ (DHCP ë‹¨ê³„ ì—†ìŒ)"
                            } catch (Exception cloneErr) {
                                echo "âš ï¸ Customization Spec ì ìš© ì‹¤íŒ¨: ${cloneErr.message}"
                                echo "âš ï¸ ëŒ€ì²´ ë°©ë²•: VM í´ë¡  í›„ SSHë¡œ ê³ ì • IP ì„¤ì •"
                                
                                // ëŒ€ì²´ ë°©ë²•: Customization ì—†ì´ í´ë¡  í›„ SSHë¡œ ì„¤ì •
                                try {
                                    def fallbackCloneOptions = "-vm=\"${templateName}\" -on=false"
                                    if (datastore && datastore != 'null' && datastore.trim() != '') {
                                        fallbackCloneOptions += " -ds=\"${datastore}\""
                                    }
                                    if (resourcePool && resourcePool != 'null' && resourcePool.trim() != '') {
                                        fallbackCloneOptions += " -pool=\"${resourcePool}\""
                                    }
                                    if (vlan && vlan != 'null' && vlan.trim() != '') {
                                        fallbackCloneOptions += " -net=\"${vlan}\""
                                    }
                                    
                                    def fallbackCloneCommand = """
                                        export GOVC_URL="${govcUrl}"
                                        export GOVC_USERNAME="${govcUser}"
                                        export GOVC_PASSWORD="${govcPass}"
                                        export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                        
                                        govc vm.clone ${fallbackCloneOptions} "${vmName}"
                                    """
                                    sh fallbackCloneCommand
                                    echo "âœ… VM í´ë¡  ì™„ë£Œ (ëŒ€ì²´ ë°©ë²• - Customization ì—†ìŒ)"
                                    
                                    // ì „ì› ì¼œê¸°
                                    def powerOnCommand = """
                                        export GOVC_URL="${govcUrl}"
                                        export GOVC_USERNAME="${govcUser}"
                                        export GOVC_PASSWORD="${govcPass}"
                                        export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                        
                                        govc vm.power -on "${vmName}"
                                    """
                                    sh powerOnCommand
                                    echo "VM ì „ì› ì¼œê¸° ì™„ë£Œ: ${vmName}"
                                } catch (Exception fallbackErr) {
                                    error("VM í´ë¡  ì‹¤íŒ¨: ${fallbackErr.message}")
                                }
                            }
                            
                            // VM ë¶€íŒ… ëŒ€ê¸° ë° IP í™•ì¸
                            if (customizationApplied) {
                                echo "=========================================="
                                echo "VM ë¶€íŒ… ëŒ€ê¸° ì¤‘ (Customization Spec ì ìš©ë¨)..."
                                echo "=========================================="
                                echo "âœ… ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IP (${vmIP})ë¡œ ì˜¬ë¼ì˜µë‹ˆë‹¤ (DHCP ë‹¨ê³„ ì—†ìŒ)"
                                
                                // Customizationì´ ì ìš©ë˜ë©´ DHCP ì—†ì´ ë°”ë¡œ ê³ ì • IPë¡œ ì˜¬ë¼ì˜´
                                // govc vm.ip -wait ì˜µì…˜ìœ¼ë¡œ IP í™•ì¸ ëŒ€ê¸°
                                def maxWait = 300  // 5ë¶„
                                def waitTime = 0
                                def vmIPConfirmed = false
                                def currentVMIP = ''
                                
                                while (waitTime < maxWait && !vmIPConfirmed) {
                                    sleep(time: 10, unit: 'SECONDS')
                                    waitTime += 10
                                    
                                    def ipCheckCommand = """
                                        export GOVC_URL="${govcUrl}"
                                        export GOVC_USERNAME="${govcUser}"
                                        export GOVC_PASSWORD="${govcPass}"
                                        export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                        
                                        govc vm.ip "${vmName}" | head -1
                                    """
                                
                                    def ipOutput = sh(
                                        script: ipCheckCommand,
                                        returnStdout: true
                                    ).trim()
                                    
                                    if (ipOutput && ipOutput != '') {
                                        currentVMIP = ipOutput
                                        vmIPConfirmed = true
                                        echo "âœ… VM IP í™•ì¸: ${currentVMIP}"
                                        
                                        // Customizationì´ ì ìš©ë˜ì—ˆìœ¼ë¯€ë¡œ í• ë‹¹ëœ IPì™€ ì¼ì¹˜í•´ì•¼ í•¨
                                        if (currentVMIP == vmIP) {
                                            echo "âœ… í• ë‹¹ëœ ê³ ì • IPì™€ ì¼ì¹˜í•©ë‹ˆë‹¤: ${vmIP}"
                                            env.NEW_VM_IP = vmIP
                                        } else {
                                            echo "âš ï¸ IP ë¶ˆì¼ì¹˜: í˜„ì¬=${currentVMIP}, í• ë‹¹=${vmIP}"
                                            echo "âš ï¸ SSHë¥¼ í†µí•´ IP ì¬ì„¤ì • ì‹œë„ ì¤‘..."
                                            // SSHë¡œ IP ì¬ì„¤ì • (ì•„ë˜ ë¡œì§ìœ¼ë¡œ)
                                            vmIPConfirmed = false  // ì¬ì„¤ì • í•„ìš”
                                        }
                                    } else {
                                        echo "VM IP ì£¼ì†Œ ëŒ€ê¸° ì¤‘... (${waitTime}/${maxWait}ì´ˆ)"
                                    }
                                }
                                
                                if (!vmIPConfirmed || !currentVMIP) {
                                    error("VM IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. VM ë¶€íŒ… ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                                }
                                
                                // IPê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ SSHë¡œ ì¬ì„¤ì •
                                if (currentVMIP != vmIP) {
                                    echo "ğŸ”§ SSHë¥¼ í†µí•´ IP ì¬ì„¤ì • ì‹œë„ ì¤‘..."
                                } else {
                                    // IPê°€ ì¼ì¹˜í•˜ë¯€ë¡œ SSH ì„¤ì • ë‹¨ê³„ ê±´ë„ˆë›°ê¸°
                                    echo "âœ… ê³ ì • IP ì„¤ì • ì™„ë£Œ: ${vmIP}"
                                    return  // ì´ stage ì¢…ë£Œ
                                }
                            } else {
                                // ëŒ€ì²´ ë°©ë²•: DHCPë¡œ ì„ì‹œ IP ë°›ì€ í›„ SSHë¡œ ê³ ì • IP ì„¤ì •
                                echo "=========================================="
                                echo "VM ë¶€íŒ… ëŒ€ê¸° ì¤‘ (ëŒ€ì²´ ë°©ë²• - DHCP ì‚¬ìš©)..."
                                echo "=========================================="
                                sleep(time: 30, unit: 'SECONDS')
                                
                                // VM IP ì£¼ì†Œ í™•ì¸ (DHCPë¡œ ë°›ì€ ì„ì‹œ IP)
                                def maxWait = 300  // 5ë¶„
                                def waitTime = 0
                                def vmIPConfirmed = false
                                def currentVMIP = ''
                                
                                while (waitTime < maxWait && !vmIPConfirmed) {
                                    sleep(time: 10, unit: 'SECONDS')
                                    waitTime += 10
                                    
                                    def ipCheckCommand = """
                                        export GOVC_URL="${govcUrl}"
                                        export GOVC_USERNAME="${govcUser}"
                                        export GOVC_PASSWORD="${govcPass}"
                                        export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                        
                                        govc vm.ip "${vmName}" | head -1
                                    """
                                
                                    def ipOutput = sh(
                                        script: ipCheckCommand,
                                        returnStdout: true
                                    ).trim()
                                    
                                    if (ipOutput && ipOutput != '') {
                                        currentVMIP = ipOutput
                                        vmIPConfirmed = true
                                        echo "VM í˜„ì¬ IP ì£¼ì†Œ: ${currentVMIP}"
                                        echo "âš ï¸ ì„ì‹œ DHCP IP í™•ì¸ë¨. ê³ ì • IPë¡œ ë³€ê²½í•©ë‹ˆë‹¤."
                                    } else {
                                        echo "VM IP ì£¼ì†Œ ëŒ€ê¸° ì¤‘... (${waitTime}/${maxWait}ì´ˆ)"
                                    }
                                }
                                
                                if (!vmIPConfirmed || !currentVMIP) {
                                    error("VM IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. VM ë¶€íŒ… ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                                }
                                
                                // í• ë‹¹ëœ IPì™€ í˜„ì¬ IPê°€ ë‹¤ë¥´ë©´ SSHë¡œ ì„¤ì •
                                echo "ğŸ” IP ë¹„êµ: í˜„ì¬=${currentVMIP}, í• ë‹¹=${vmIP}, ì¼ì¹˜=${currentVMIP == vmIP}"
                                if (currentVMIP != vmIP) {
                                echo "âš ï¸ VM IPê°€ í• ë‹¹ëœ IPì™€ ë‹¤ë¦…ë‹ˆë‹¤. í˜„ì¬: ${currentVMIP}, í• ë‹¹: ${vmIP}"
                                echo "ğŸ”§ SSHë¥¼ í†µí•´ IP ì„¤ì • ì‹œë„ ì¤‘..."

                                // SSH í‚¤ ê²½ë¡œ í™•ì¸ (ì„¤ì •ì—ì„œ ì§€ì •í•œ í‚¤ ì‚¬ìš©)
                                def sshKey = null

                                // ë””ë²„ê¹…: í™˜ê²½ ë³€ìˆ˜ í™•ì¸
                                echo "ğŸ› DEBUG: env.SSH_KEY_PATH = '${env.SSH_KEY_PATH}'"
                                echo "ğŸ› DEBUG: WORKSPACE = '${env.WORKSPACE}'"

                                // 1ìˆœìœ„: í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ëœ SSH í‚¤ ê²½ë¡œ (ë°±ì—”ë“œ APIì—ì„œ ì¡°íšŒ)
                                if (env.SSH_KEY_PATH && env.SSH_KEY_PATH != 'null' && env.SSH_KEY_PATH.trim() != '') {
                                    def sshKeyPath = env.SSH_KEY_PATH.trim()
                                    echo "ğŸ”‘ ì„¤ì •ì—ì„œ ì§€ì •í•œ SSH í‚¤ ê²½ë¡œ: ${sshKeyPath}"
                                    
                                    // ì—¬ëŸ¬ ê°€ëŠ¥í•œ ê²½ë¡œ ì‹œë„
                                    def possiblePaths = []
                                    
                                    // ì ˆëŒ€ ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‹œë„
                                    possiblePaths.add(sshKeyPath)
                                    
                                    // Jenkins ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê¸°ì¤€ ìƒëŒ€ ê²½ë¡œ ì‹œë„
                                    if (env.WORKSPACE) {
                                        // ê²½ë¡œì—ì„œ pemkey/ ì´í›„ ë¶€ë¶„ ì¶”ì¶œ
                                        def keyName = sshKeyPath.split('pemkey/')[-1]
                                        if (keyName) {
                                            possiblePaths.add("${env.WORKSPACE}/pemkey/${keyName}")
                                            possiblePaths.add("${env.WORKSPACE}/../pemkey/${keyName}")
                                        }
                                    }
                                    
                                    // íŒŒì¼ëª…ë§Œ ì¶”ì¶œí•˜ì—¬ ì—¬ëŸ¬ ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰
                                    def fileName = sshKeyPath.split('/')[-1]
                                    if (fileName) {
                                        possiblePaths.add("${env.WORKSPACE}/pemkey/${fileName}")
                                        possiblePaths.add("${env.WORKSPACE}/../pemkey/${fileName}")
                                        possiblePaths.add("/home/ubuntu/workspace/vm-autoscaling/pemkey/${fileName}")
                                        possiblePaths.add("/var/lib/jenkins/workspace/vm-autoscaling/pemkey/${fileName}")
                                    }
                                    
                                    // ê° ê²½ë¡œ í™•ì¸
                                    for (def path in possiblePaths) {
                                        def keyExists = sh(
                                            script: "test -f '${path}' && echo 'exists' || echo 'not found'",
                                            returnStdout: true
                                        ).trim()
                                        echo "  - ${path}: ${keyExists}"
                                        if (keyExists == 'exists') {
                                            sshKey = path
                                            echo "âœ… SSH í‚¤ ë°œê²¬: ${sshKey}"
                                            break
                                        }
                                    }
                                    
                                    if (!sshKey) {
                                        echo "âš ï¸ ì„¤ì •ì—ì„œ ì§€ì •í•œ SSH í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${sshKeyPath}"
                                    }
                                }

                                // 2ìˆœìœ„: ê¸°ë³¸ í‚¤ ëª©ë¡ì—ì„œ ìë™ ê²€ìƒ‰ (Fallback)
                                if (!sshKey) {
                                    echo "ğŸ”‘ ê¸°ë³¸ SSH í‚¤ ìë™ ê²€ìƒ‰ ì‹œì‘..."
                                    def basePaths = []
                                    if (env.WORKSPACE) {
                                        basePaths.add("${env.WORKSPACE}/pemkey")
                                        basePaths.add("${env.WORKSPACE}/../pemkey")
                                    }
                                    basePaths.add("/home/ubuntu/workspace/vm-autoscaling/pemkey")
                                    basePaths.add("/var/lib/jenkins/workspace/vm-autoscaling/pemkey")
                                    
                                    def keyNames = ["danainfra", "dana-cocktail", "jenkins"]
                                    
                                    for (def basePath in basePaths) {
                                        for (def keyName in keyNames) {
                                            def keyPath = "${basePath}/${keyName}"
                                            def keyExists = sh(
                                                script: "test -f '${keyPath}' && echo 'exists' || echo 'not found'",
                                                returnStdout: true
                                            ).trim()
                                            echo "  - ${keyPath}: ${keyExists}"
                                            if (keyExists == 'exists') {
                                                sshKey = keyPath
                                                echo "âœ… SSH í‚¤ ë°œê²¬: ${sshKey}"
                                                break
                                            }
                                        }
                                        if (sshKey) break
                                    }
                                }

                                if (sshKey) {
                                    echo "ğŸ”§ SSH í‚¤ ì‚¬ìš©: ${sshKey}"
                                    // ì„œë¸Œë„· ë§ˆìŠ¤í¬ë¥¼ CIDRë¡œ ë³€í™˜
                                    def subnetMask = subnet
                                    def cidr = sh(
                                        script: """
                                            python3 -c "
import ipaddress
netmask = '${subnetMask}'
# ì„œë¸Œë„· ë§ˆìŠ¤í¬ë¥¼ CIDRë¡œ ë³€í™˜
if netmask == '255.255.255.0':
    cidr = 24
elif netmask == '255.255.0.0':
    cidr = 16
elif netmask == '255.0.0.0':
    cidr = 8
else:
    # ì¼ë°˜ì ì¸ ë³€í™˜
    cidr = sum(bin(int(x)).count('1') for x in netmask.split('.'))
print(cidr)
"
                                        """,
                                        returnStdout: true
                                    ).trim()
                                    
                                    echo "Netplan ì„¤ì •: IP=${vmIP}/${cidr}, Gateway=${gateway}"
                                    
                                    // SSHë¡œ Netplan ì„¤ì •
                                    def maxRetries = 5
                                    def retryCount = 0
                                    def ipConfigured = false
                                    
                                    while (retryCount < maxRetries && !ipConfigured) {
                                        try {
                                            echo "ğŸ”Œ SSH ì—°ê²° ì‹œë„ (${retryCount + 1}/${maxRetries}): ubuntu@${currentVMIP}"
                                            
                                            // SSH í‚¤ ê¶Œí•œ ì„¤ì • (0600ìœ¼ë¡œ ë³€ê²½)
                                            sh """
                                                chmod 600 ${sshKey} || true
                                            """
                                            
                                            // known_hostsì—ì„œ í•´ë‹¹ IP ì œê±° (í˜¸ìŠ¤íŠ¸ í‚¤ ë³€ê²½ ë¬¸ì œ í•´ê²°)
                                            sh """
                                                ssh-keygen -f ~/.ssh/known_hosts -R ${currentVMIP} 2>/dev/null || true
                                            """
                                            
                                            // Groovy ë³€ìˆ˜ë¥¼ Shell ë³€ìˆ˜ë¡œ ì„¤ì •
                                            def vmIPVar = vmIP
                                            def cidrVar = cidr
                                            def gatewayVar = gateway
                                            def vmNameVar = vmName
                                            
                                            sh """
                                                ssh -i ${sshKey} \\
                                                    -o StrictHostKeyChecking=no \\
                                                    -o UserKnownHostsFile=/dev/null \\
                                                    -o ConnectTimeout=10 \\
                                                    ubuntu@${currentVMIP} bash -s << SSH_SCRIPT_EOF
# í…œí”Œë¦¿ì˜ ê¸°ì¡´ IP ì¶©ëŒ ë°©ì§€: ê¸°ì¡´ Netplan ì„¤ì • ë°±ì—… ë° ì‚­ì œ
echo "ê¸°ì¡´ ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì´ˆê¸°í™” ì¤‘..."
sudo rm -f /etc/netplan/*.yaml /etc/netplan/*.yml 2>/dev/null || true
sudo systemctl stop systemd-networkd 2>/dev/null || true
sudo systemctl start systemd-networkd 2>/dev/null || true
sleep 2

# ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ í™•ì¸ (ens33, ens192, ens160, eth0 ë“±)
# ìš°ì„ ìˆœìœ„: ens33 > ens192 > ens160 > eth0 > ê¸°íƒ€
INTERFACE=\$(ip -br link show | grep -v lo | grep -E '^(ens33|ens192|ens160|eth0)' | head -1 | cut -d' ' -f1)
if [ -z "\\\${INTERFACE}" ]; then
    # ìš°ì„ ìˆœìœ„ ì¸í„°í˜ì´ìŠ¤ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©
    INTERFACE=\$(ip -br link show | grep -v lo | head -1 | cut -d' ' -f1)
fi
echo "ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤: \\\${INTERFACE}"

# ìƒˆë¡œìš´ Netplan ì„¤ì • (ê³ ì • IP, DHCP ë¹„í™œì„±í™”)
sudo tee /etc/netplan/01-netcfg.yaml > /dev/null << NETPLAN_EOF
network:
  version: 2
  renderer: networkd
  ethernets:
    \\\${INTERFACE}:
      dhcp4: no
      dhcp6: no
      addresses:
        - ${vmIPVar}/${cidrVar}
      gateway4: ${gatewayVar}
      nameservers:
        addresses:
          - 10.255.0.10
NETPLAN_EOF

sudo netplan apply
sleep 3
hostnamectl set-hostname ${vmNameVar}
echo "ê³ ì • IP ì„¤ì • ì™„ë£Œ: ${vmIPVar}/${cidrVar}"
SSH_SCRIPT_EOF
                                            """
                                            ipConfigured = true
                                            echo "âœ… VM IP ì„¤ì • ì™„ë£Œ: ${vmIP}"
                                        } catch (Exception sshErr) {
                                            retryCount++
                                            echo "SSH ì ‘ì† ì‹¤íŒ¨ (${retryCount}/${maxRetries}): ${sshErr.message}"
                                            if (retryCount < maxRetries) {
                                                sleep(time: 10, unit: 'SECONDS')
                                            }
                                        }
                                    }
                                    
                                    if (ipConfigured) {
                                        env.NEW_VM_IP = vmIP
                                        echo "âœ… VM IPê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${vmIP}"
                                    } else {
                                        echo "âš ï¸ VM IP ìë™ ì„¤ì • ì‹¤íŒ¨. í˜„ì¬ IP (${currentVMIP})ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                                        env.NEW_VM_IP = currentVMIP
                                    }
                                } else {
                                    echo "âŒ SSH í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ IP (${currentVMIP})ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                                    env.NEW_VM_IP = currentVMIP
                                }
                            } else {
                                env.NEW_VM_IP = vmIP
                                echo "âœ… VM IPê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${vmIP}"
                            }

                            echo "ğŸ“Œ ìµœì¢… VM IP: ${env.NEW_VM_IP}"
                        
                        } catch (Exception e) {
                            echo "VM í´ë¡  ì‹¤íŒ¨: ${e.getMessage()}"
                            error("VM í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 5: F5 Pool Member ì¶”ê°€
        stage('F5 Pool Registration') {
            steps {
                script {
                    echo "=========================================="
                    echo "F5 Pool Member ì¶”ê°€ ì‹œì‘"
                    echo "=========================================="
                    
                    def poolName = env.F5_POOL_NAME
                    def memberIP = env.NEW_VM_IP
                    def port = env.F5_POOL_PORT.toInteger()
                    
                    if (!poolName || poolName == '') {
                        error("F5 Pool ì´ë¦„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    if (!memberIP || memberIP == 'null' || memberIP == '') {
                        error("VM IP ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // F5 Credential ì‚¬ìš©
                    withCredentials([usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME', passwordVariable: 'F5_PASSWORD')]) {
                        try {
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” curlì„ ì‚¬ìš©í•˜ì—¬ F5 API í˜¸ì¶œ
                            
                            echo "Linux í™˜ê²½ì—ì„œ F5 API í˜¸ì¶œ..."
                            
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ)
                            sh """
                                python3 ${WORKSPACE}/scripts/add-f5-pool-member.py \
                                    --pool ${poolName} \
                                    --member ${memberIP}:${port} \
                                    --server ${env.F5_SERVER} \
                                    --username ${env.F5_USERNAME} \
                                    --password '${env.F5_PASSWORD}'
                            """
                            
                            echo "F5 Pool Member ì¶”ê°€ ì™„ë£Œ: ${memberIP}:${port}"
                        } catch (Exception e) {
                            echo "F5 Pool Member ì¶”ê°€ ì‹¤íŒ¨: ${e.getMessage()}"
                            // F5 ë“±ë¡ ì‹¤íŒ¨ëŠ” ê²½ê³ ë¡œ ì²˜ë¦¬ (VMì€ ì´ë¯¸ ìƒì„±ë¨)
                            currentBuild.result = 'UNSTABLE'
                            echo "ê²½ê³ : F5 Pool ë“±ë¡ ì‹¤íŒ¨í–ˆì§€ë§Œ VMì€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
                        }
                    }
                }
            }
        }
        
        // Stage 6: ê²°ê³¼ ìš”ì•½
        stage('Summary') {
            steps {
                script {
                    echo "=========================================="
                    echo "ì‘ì—… ì™„ë£Œ ìš”ì•½"
                    echo "=========================================="
                    echo "Alert: ${env.alertname}"
                    echo "Service: ${env.ALERT_SERVICE}"
                    echo "Instance: ${env.VM_INSTANCE}"
                    echo "ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}"
                    echo "ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}"
                    echo "F5 Pool: ${env.F5_POOL_NAME}"
                    echo "F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}"
                    echo "=========================================="
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline ì‹¤í–‰ ì™„ë£Œ"
            // ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            script {
                def summary = """
                    Alert: ${env.alertname}
                    Service: ${env.ALERT_SERVICE}
                    Instance: ${env.VM_INSTANCE}
                    ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}
                    ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}
                    F5 Pool: ${env.F5_POOL_NAME}
                    F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}
                    ì‹¤í–‰ ì‹œê°„: ${currentBuild.durationString}
                    ê²°ê³¼: ${currentBuild.result ?: 'SUCCESS'}
                """
                writeFile file: 'pipeline-summary.txt', text: summary
                archiveArtifacts artifacts: 'pipeline-summary.txt', fingerprint: true
            }
        }
        success {
            echo "âœ… ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì„±ê³µ"
        }
        failure {
            echo "âŒ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì‹¤íŒ¨"
        }
        unstable {
            echo "âš ï¸ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ë¶€ë¶„ ì‹¤íŒ¨ (VM ìƒì„± ì„±ê³µ, F5 ë“±ë¡ ì‹¤íŒ¨)"
        }
    }
}
