// Jenkins Pipeline í†µí•© ìŠ¤í¬ë¦½íŠ¸ (Linux í™˜ê²½ìš© - govc ì‚¬ìš©)
// Alertmanager Webhook â†’ Jenkins â†’ vCenter API (govc) â†’ F5 Pool ìë™ ë“±ë¡ íŒŒì´í”„ë¼ì¸
// Job ì´ë¦„: plg-autoscale-out

pipeline {
    agent any
    
    // Generic Webhook Trigger ì„¤ì •
    triggers {
        GenericTrigger(
            genericVariables: [
                // Alertmanagerì—ì„œ ì „ë‹¬ë˜ëŠ” ë°ì´í„° íŒŒì‹±
                [key: 'alertname', value: '$.alerts[0].labels.alertname', regexpFilter: ''],
                [key: 'instance', value: '$.alerts[0].labels.instance', regexpFilter: ''],
                [key: 'service', value: '$.alerts[0].labels.service', regexpFilter: ''],
                [key: 'autoscaleConfigId', value: '$.alerts[0].labels.autoscaleConfigId', regexpFilter: ''],
                [key: 'severity', value: '$.alerts[0].labels.severity', regexpFilter: ''],
                [key: 'status', value: '$.status', regexpFilter: ''],
                [key: 'summary', value: '$.alerts[0].annotations.summary', regexpFilter: ''],
                [key: 'description', value: '$.alerts[0].annotations.description', regexpFilter: '']
            ],
            causeString: 'Alert: $alertname - Service: $service - Instance: $instance',
            token: 'plg-autoscale-token',
            printContributedVariables: true,
            printPostContent: true,
            // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ (firingë§Œ ì²˜ë¦¬)
            regexpFilterText: '$status',
            regexpFilterExpression: '^firing$'
        )
    }
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // vCenter ì„¤ì • (Jenkins Credentials ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…)
        GOVC_URL = ''
        GOVC_USERNAME = ''
        GOVC_PASSWORD = ''
        GOVC_INSECURE = '1'  // SSL ì¸ì¦ì„œ ê²€ì¦ ë¹„í™œì„±í™”
        
        // ê¸°ë³¸ vCenter ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        VCENTER_RESOURCE_POOL = 'APP-RP'
        VCENTER_DATASTORE = 'OS-Datastore-Power-Store'
        
        // F5 ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        // ê³ ì • ì„œë²„: F5 ì„œë²„ (í™˜ê²½ ë³€ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
        F5_SERVER = "${env.F5_SERVER ?: '10.255.1.80'}"
        F5_PARTITION = 'Common'
        F5_HEALTH_MONITOR = '/Common/http'
        F5_USERNAME = ''
        F5_PASSWORD = ''
        
        // ë°±ì—”ë“œ API URL (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒìš©)
        // ê³ ì • ì„œë²„: VM Autoscaling ì„œë²„ (í™˜ê²½ ë³€ìˆ˜ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
        BACKEND_API_URL = "${env.BACKEND_API_URL ?: 'http://10.255.48.253:6010'}"
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        VM_IP_TIMEOUT = '300'  // 5ë¶„
    }
    
    stages {
        // Stage 1: Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦
        stage('Parse Alert') {
            steps {
                script {
                    echo "=========================================="
                    echo "Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦"
                    echo "=========================================="
                    
                    def alertname = env.alertname ?: 'Unknown'
                    def instance = env.instance ?: 'all'
                    def service = env.service ?: 'unknown'
                    def autoscaleConfigId = env.autoscaleConfigId ?: ''
                    def severity = env.severity ?: 'warning'
                    def status = env.status ?: 'unknown'
                    def summary = env.summary ?: ''
                    def description = env.description ?: ''
                    
                    echo "Alert Name: ${alertname}"
                    echo "Service: ${service}"
                    echo "Instance: ${instance}"
                    echo "Autoscale Config ID: ${autoscaleConfigId}"
                    echo "Severity: ${severity}"
                    echo "Status: ${status}"
                    echo "Summary: ${summary}"
                    echo "Description: ${description}"
                    
                    // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ
                    if (status != 'firing') {
                        echo "Alert status is '${status}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Critical ë˜ëŠ” Warning ì•Œë¦¼ë§Œ ì²˜ë¦¬
                    if (severity != 'critical' && severity != 'warning') {
                        echo "Alert severity is '${severity}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Autoscale Config IDê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜
                    if (!autoscaleConfigId) {
                        error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤. Alert Rule ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
                    }
                    
                    // í™˜ê²½ ë³€ìˆ˜ ì €ì¥
                    env.VM_INSTANCE = instance
                    env.ALERT_SERVICE = service
                    env.ALERT_SEVERITY = severity
                    env.AUTOSCALE_CONFIG_ID = autoscaleConfigId
                    
                    echo "Alert íŒŒì‹± ì™„ë£Œ. ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì¤‘..."
                }
            }
        }
        
        // Stage 2: ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ
        stage('Get Autoscaling Config') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED'),
                        usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME_CRED', passwordVariable: 'F5_PASSWORD_CRED')
                    ]) {
                        echo "=========================================="
                        echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ"
                       	echo "=========================================="
                        
                        if (!env.GOVC_URL || env.GOVC_URL.trim() == '') {
                            env.GOVC_URL = VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        }
                        if (!env.GOVC_USERNAME || env.GOVC_USERNAME.trim() == '') {
                            env.GOVC_USERNAME = VCENTER_USER_CRED ?: 'svc-auto'
                        }
                        if (!env.GOVC_PASSWORD || env.GOVC_PASSWORD.trim() == '') {
                            if (VCENTER_PASSWORD_CRED && VCENTER_PASSWORD_CRED.trim() != '') {
                                env.GOVC_PASSWORD = VCENTER_PASSWORD_CRED
                            } else {
                                error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Jenkins Credentials 'vcenter-password'ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                            }
                        }
                        
                        env.F5_USERNAME = F5_USERNAME_CRED ?: env.F5_USERNAME
                        env.F5_PASSWORD = F5_PASSWORD_CRED ?: env.F5_PASSWORD
                        
                        def configId = env.AUTOSCALE_CONFIG_ID
                        if (!configId || configId.trim() == '') {
                            error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            echo "ë°±ì—”ë“œ API í˜¸ì¶œ: ${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}"
                            def configResponseText = sh(
                                script: """curl -sf -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}" """,
                                returnStdout: true
                            ).trim()
                            
                            def configResponse = new groovy.json.JsonSlurper().parseText(configResponseText)
                            def configData = configResponse.config ?: configResponse
                            
                            // ë””ë²„ê¹…: vCenter ì •ë³´ í™•ì¸
                            echo "ë””ë²„ê¹…: configData.vcenter = ${configData.vcenter}"
                            if (configData.vcenter) {
                                echo "ë””ë²„ê¹…: vcenter.resourcePool = ${configData.vcenter.resourcePool}"
                                echo "ë””ë²„ê¹…: vcenter.datastore = ${configData.vcenter.datastore}"
                            }
                            
                            if (!configData.serviceName) {
                                error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${configResponseText}")
                            }
                            
                            if (configData.templateId) {
                                echo "ğŸ“ Template ì •ë³´ ì¡°íšŒ: ${configData.templateId}"
                                try {
                                    // HTTP ì‘ë‹µ ì½”ë“œì™€ ë³¸ë¬¸ì„ ë¶„ë¦¬í•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
                                    def templateResponseText = sh(
                                        script: """curl -s -w "\\nHTTP_CODE:%{http_code}" -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/templates/${configData.templateId}" """,
                                        returnStdout: true
                                    ).trim()

                                    // HTTP ì½”ë“œ ì¶”ì¶œ
                                    def httpCodeMatch = templateResponseText =~ /HTTP_CODE:(\\d+)/
                                    def httpCode = httpCodeMatch ? httpCodeMatch[0][1] : '000'
                                    def responseBody = templateResponseText.replaceAll(/HTTP_CODE:\\d+$/, '').trim()

                                    echo "ğŸ” Template API HTTP ì‘ë‹µ ì½”ë“œ: ${httpCode}"
                                    echo "ğŸ” Template API ì‘ë‹µ ë³¸ë¬¸ (ì²˜ìŒ 200ì): ${responseBody.take(200)}"

                                    if (httpCode == '200' && responseBody) {
                                        try {
                                            // JSON íŒŒì‹± ì‹œ ì§ë ¬í™” ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                                            def templateJson = readJSON text: responseBody
                                            def templateName = templateJson?.template?.name ?: templateJson?.name

                                            if (templateName && templateName != '' && templateName != 'null') {
                                                // í…œí”Œë¦¿ ì´ë¦„ ì•ë’¤ ê³µë°± ì œê±° (vCenterì—ì„œ ì •í™•í•œ ì´ë¦„ìœ¼ë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•´)
                                                env.VCENTER_TEMPLATE = templateName.toString().trim()
                                                echo "âœ… Template ì´ë¦„: ${env.VCENTER_TEMPLATE}"
                                            } else {
                                                echo "âš ï¸ Template ì´ë¦„ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                                env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                            }
                                        } catch (Exception jsonErr) {
                                            echo "âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨: ${jsonErr.message}"
                                            echo "âš ï¸ ì‘ë‹µ ë³¸ë¬¸: ${responseBody.take(500)}"
                                            echo "âš ï¸ ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                            env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                        }
                                    } else {
                                        echo "âš ï¸ Template API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ${httpCode}). ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                        if (responseBody) {
                                            echo "âš ï¸ ì‘ë‹µ ë³¸ë¬¸: ${responseBody.take(500)}"
                                        }
                                        env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                    }
                                } catch (Exception tmplErr) {
                                    echo "âš ï¸ Template ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ: ${tmplErr.class.name}"
                                    echo "âš ï¸ ì˜ˆì™¸ ë©”ì‹œì§€: ${tmplErr.message}"
                                    echo "âš ï¸ ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                    env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                }
                            } else {
                                echo "âš ï¸ templateIdê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                            }
                            
                            // VM ì´ë¦„ ìƒì„±: ê¸°ì¡´ VM ëª©ë¡ í™•ì¸ í›„ ë‹¤ìŒ ìˆœì°¨ ë²ˆí˜¸ ìƒì„±
                            def serviceName = configData.serviceName ?: 'app'
                            def serviceNameClean = serviceName.toLowerCase().replaceAll(/[^a-z0-9-]/, '-')

                            // serviceNameì—ì„œ ì ‘ë¯¸ì‚¬ ì œê±° (ì˜ˆ: auto-vm-test-service -> auto-vm-test)
                            def parts = serviceNameClean.split('-')
                            def baseName = serviceNameClean
                            if (parts.size() > 1) {
                                def lastPart = parts[-1]
                                if (lastPart in ['service', 'job', 'app', 'api', 'web']) {
                                    baseName = parts[0..-2].join('-')
                                }
                            }

                            echo "ì„œë¹„ìŠ¤ ì´ë¦„: ${serviceNameClean}"
                            echo "ê¸°ë³¸ ì´ë¦„: ${baseName}"

                            // VM Prefix ê²°ì • (ì‚¬ìš©ì ì§€ì • ë˜ëŠ” ê¸°ë³¸ê°’)
                            def vmPrefix = env.VM_PREFIX ?: baseName
                            echo "VM Prefix: ${vmPrefix}"

                            // VM ì´ë¦„ ìƒì„± (prefix-íƒ€ì„ìŠ¤íƒ¬í”„ í˜•ì‹: prefix-YYYYMMDDHHmm)
                            def timestamp = new Date().format('yyyyMMddHHmm')
                            env.NEW_VM_NAME = "${vmPrefix}-${timestamp}"
                            env.VM_HOSTNAME = env.NEW_VM_NAME  // í˜¸ìŠ¤íŠ¸ë„¤ì„ë„ ë™ì¼í•˜ê²Œ ì„¤ì •

                            echo "ìƒì„±í•  VM ì´ë¦„: ${env.NEW_VM_NAME}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME}"
                            echo "íƒ€ì„ìŠ¤íƒ¬í”„: ${timestamp}"
                            
                            env.IP_POOL_START = configData.network?.ipPoolStart ?: ''
                            env.IP_POOL_END = configData.network?.ipPoolEnd ?: ''
                            env.SUBNET = configData.network?.subnet ?: '255.255.255.0'
                            env.GATEWAY = configData.network?.gateway ?: ''
                            env.VLAN = configData.network?.vlan ?: ''
                            
                            env.F5_POOL_NAME = configData.f5?.poolName ?: ''
                            env.F5_POOL_PORT = configData.f5?.vipPort ?: '80'
                            env.F5_VIP = configData.f5?.vip ?: ''
                            env.F5_HEALTH_CHECK_PATH = configData.f5?.healthCheckPath ?: '/'
                            
                            // SSH í‚¤ ê²½ë¡œ ë° VM Prefix ì„¤ì • (ë°±ì—”ë“œ APIì—ì„œ ì¡°íšŒ)
                            env.SSH_KEY_PATH = configData.sshKeyPath ?: ''
                            env.VM_PREFIX = configData.vmPrefix ?: ''
                            echo "SSH í‚¤ ê²½ë¡œ: ${env.SSH_KEY_PATH ?: 'ë¯¸ì§€ì • (Fallback ì‚¬ìš©)'}"
                            echo "VM Prefix: ${env.VM_PREFIX ?: 'ë¯¸ì§€ì • (ê¸°ë³¸ê°’ ì‚¬ìš©)'}"
                            
                            // Prometheus Job ì´ë¦„ ì„¤ì •
                            env.PROMETHEUS_JOB_NAME = configData.monitoring?.prometheusJobName ?: configData.prometheusJobName ?: ''
                            echo "Prometheus Job ì´ë¦„: ${env.PROMETHEUS_JOB_NAME ?: 'ë¯¸ì§€ì •'}"
                            
                            // vCenter ì •ë³´ ì„¤ì • (LazyMap ì§ì ‘ ì ‘ê·¼)
                            def vcenterInfo = configData.vcenter
                            def vcenterResourcePool = null
                            def vcenterDatastore = null
                            
                            if (vcenterInfo) {
                                // LazyMapì—ì„œ ì§ì ‘ ê°’ ê°€ì ¸ì˜¤ê¸°
                                vcenterResourcePool = vcenterInfo.get('resourcePool')
                                vcenterDatastore = vcenterInfo.get('datastore')
                                echo "ë””ë²„ê¹…: vcenterInfoì—ì„œ ì¶”ì¶œ - resourcePool=${vcenterResourcePool}, datastore=${vcenterDatastore}"
                            }
                            
                            // vCenter ì„¤ì •ì„ ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¡œ ì €ì¥ (í™˜ê²½ ë³€ìˆ˜ëŠ” ë³€ê²½ ë¶ˆê°€)
                            def finalResourcePool = vcenterResourcePool?.toString()?.trim()
                            if (!finalResourcePool || finalResourcePool == '' || finalResourcePool == 'null') {
                                finalResourcePool = env.VCENTER_RESOURCE_POOL
                                echo "âš  vCenter Resource Pool: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalResourcePool})"
                            } else {
                                echo "âœ“ vCenter Resource Pool: ${finalResourcePool}"
                            }

                            def finalDatastore = vcenterDatastore?.toString()?.trim()
                            if (!finalDatastore || finalDatastore == '' || finalDatastore == 'null') {
                                finalDatastore = env.VCENTER_DATASTORE
                                echo "âš  vCenter Datastore: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalDatastore})"
                            } else {
                                echo "âœ“ vCenter Datastore: ${finalDatastore}"
                            }

                            // ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ë„ ì €ì¥ (ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œ ì‚¬ìš©)
                            env.FINAL_RESOURCE_POOL = finalResourcePool
                            env.FINAL_DATASTORE = finalDatastore
                            
                            echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì™„ë£Œ:"
                            echo "  Template: ${env.VCENTER_TEMPLATE}"
                            echo "  VM Name: ${env.NEW_VM_NAME}"
                            echo "  IP Pool: ${env.IP_POOL_START} - ${env.IP_POOL_END}"
                            echo "  F5 Pool: ${env.F5_POOL_NAME}"
                            echo "  F5 VIP: ${env.F5_VIP}"
                            echo "  Resource Pool: ${finalResourcePool}"
                            echo "  Datastore: ${finalDatastore}"
                            
                        } catch (Exception e) {
                            error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 3: IP ì£¼ì†Œ í• ë‹¹
        stage('Allocate IP Address') {
            steps {
                script {
                    echo "=========================================="
                    echo "IP ì£¼ì†Œ í• ë‹¹"
                    echo "=========================================="
                    
                    def ipStart = env.IP_POOL_START
                    def ipEnd = env.IP_POOL_END
                    
                    if (!ipStart || !ipEnd) {
                        error("IP Poolì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // IP Poolì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸°
                    // ê°„ë‹¨í•œ ë°©ë²•: IP Pool ë²”ìœ„ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸
                    def allocatedIP = ''
                    
                    // IP ì£¼ì†Œë¥¼ ìˆ«ìë¡œ ë³€í™˜
                    def ipStartParts = ipStart.split('\\.')
                    def ipEndParts = ipEnd.split('\\.')
                    
                    def startLong = ipStartParts[0].toLong() * 256 * 256 * 256 +
                                   ipStartParts[1].toLong() * 256 * 256 +
                                   ipStartParts[2].toLong() * 256 +
                                   ipStartParts[3].toLong()
                    
                    def endLong = ipEndParts[0].toLong() * 256 * 256 * 256 +
                                 ipEndParts[1].toLong() * 256 * 256 +
                                 ipEndParts[2].toLong() * 256 +
                                 ipEndParts[3].toLong()
                    
                    // IP Pool ë²”ìœ„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸° (ping í…ŒìŠ¤íŠ¸)
                    for (long ip = startLong; ip <= endLong; ip++) {
                        // ìˆ«ìë¥¼ IPë¡œ ë³€í™˜
                        def octet1 = (ip >> 24) & 0xFF
                        def octet2 = (ip >> 16) & 0xFF
                        def octet3 = (ip >> 8) & 0xFF
                        def octet4 = ip & 0xFF
                        def testIP = "${octet1}.${octet2}.${octet3}.${octet4}"
                        
                        // pingìœ¼ë¡œ IP ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                        def pingResult = sh(
                            script: "ping -c 1 -W 1 ${testIP} > /dev/null 2>&1",
                            returnStatus: true
                        )
                        
                        if (pingResult != 0) {
                            // ping ì‹¤íŒ¨ = IP ì‚¬ìš© ê°€ëŠ¥
                            allocatedIP = testIP
                            break
                        }
                    }
                    
                    if (!allocatedIP) {
                        def errorMessage = "IP Pool (${ipStart} - ${ipEnd})ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IPë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                        echo "âŒ ${errorMessage}"
                        echo "âš ï¸ IP Pool ë²”ìœ„ë¥¼ í™•ì¥í•˜ê±°ë‚˜ ê¸°ì¡´ VMì„ í™•ì¸í•´ì£¼ì„¸ìš”."
                        
                        // ë°±ì—”ë“œì— IP Pool ë¶€ì¡± ì•Œë¦¼ (ì¿¨ë‹¤ìš´ ì‹œì‘ì„ ìœ„í•´)
                        try {
                            def backendApiUrl = env.BACKEND_API_URL ?: 'http://10.255.48.253:6010'
                            def serviceName = env.ALERT_SERVICE
                            
                            if (serviceName) {
                                def { startCooldown } = require('./services/cooldownService')
                                // ì¿¨ë‹¤ìš´ì€ ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¡œê·¸ë§Œ ë‚¨ê¹€
                                echo "ë°±ì—”ë“œì— IP Pool ë¶€ì¡± ì•Œë¦¼ ì „ì†¡ (ì¿¨ë‹¤ìš´ ì‹œì‘ì„ ìœ„í•´)"
                            }
                        } catch (Exception e) {
                            echo "ë°±ì—”ë“œ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰): ${e.getMessage()}"
                        }
                        
                        error(errorMessage)
                    }
                    
                    env.NEW_VM_IP = allocatedIP
                    echo "IP ì£¼ì†Œ í• ë‹¹ ì™„ë£Œ: ${env.NEW_VM_IP}"
                }
            }
        }
        
        // Stage 4: vCenter VM í´ë¡  (govc ì‚¬ìš©)
        stage('VM Clone') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED')
                    ]) {
                    echo "=========================================="
                    echo "vCenter VM í´ë¡  ì‹œì‘ (govc ì‚¬ìš©)"
                    echo "=========================================="
                    
                    def templateName = env.VCENTER_TEMPLATE
                    def vmName = env.NEW_VM_NAME
                    def vmIP = env.NEW_VM_IP
                    def subnet = env.SUBNET
                    def gateway = env.GATEWAY
                    def vlan = env.VLAN
                        def datastore = env.FINAL_DATASTORE ?: env.VCENTER_DATASTORE
                        def resourcePool = env.FINAL_RESOURCE_POOL ?: env.VCENTER_RESOURCE_POOL
                    
                        // vCenter Credentials ì¬í™•ì¸
                        def govcUrl = env.GOVC_URL ?: VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        def govcUser = env.GOVC_USERNAME ?: VCENTER_USER_CRED ?: 'svc-auto'
                        def govcPass = env.GOVC_PASSWORD ?: VCENTER_PASSWORD_CRED
                        
                        if (!govcPass || govcPass == 'null' || govcPass.trim() == '') {
                            error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            // vCenter Linux Customization Specì„ ì‚¬ìš©í•˜ì—¬ ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IP ì„¤ì •
                            // ë°©ë²•: vm.clone -on=false â†’ vm.customize -ip ... â†’ vm.power -on
                            echo "=========================================="
                            echo "vCenter VM í´ë¡  ë° Guest Customization (ê³ ì • IP ì„¤ì •)..."
                            echo "=========================================="
                            echo "í• ë‹¹ëœ IP: ${vmIP}"
                            echo "ì„œë¸Œë„·: ${subnet}"
                            echo "ê²Œì´íŠ¸ì›¨ì´: ${gateway}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME ?: vmName}"
                            
                            // DNS ì„œë²„ (ê¸°ë³¸ê°’)
                            def dnsServers = '10.255.0.10'
                            
                            // Customization Spec ì´ë¦„ (í™˜ê²½ ë³€ìˆ˜ë¡œ ì œê³µë˜ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì§ì ‘ IP ì„¤ì •)
                            def customizationSpecName = env.CUSTOMIZATION_SPEC_NAME ?: null
                            
                            // ==========================================
                            // (1) VM í´ë¡  (ì „ì› OFF ìƒíƒœ)
                            // ==========================================
                            echo ""
                            echo "Step 1: VM í´ë¡  (ì „ì› êº¼ì§„ ìƒíƒœ)..."
                            
                            def cloneOptions = "-vm=\"${templateName}\" -on=false"
                        
                        // Datastore ì§€ì •
                            if (datastore && datastore != 'null' && datastore.trim() != '') {
                                cloneOptions += " -ds=\"${datastore}\""
                        }
                        
                        // Resource Pool ì§€ì •
                            if (resourcePool && resourcePool != 'null' && resourcePool.trim() != '') {
                                cloneOptions += " -pool=\"${resourcePool}\""
                        }
                        
                        // Network/VLAN ì§€ì •
                            if (vlan && vlan != 'null' && vlan.trim() != '') {
                                cloneOptions += " -net=\"${vlan}\""
                        }
                        
                            def cloneCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                                govc vm.clone ${cloneOptions} "${vmName}"
                            """
                            
                            sh cloneCommand
                            echo "âœ… VM í´ë¡  ì™„ë£Œ (ì „ì› êº¼ì§„ ìƒíƒœ): ${vmName}"
                        
                            // ==========================================
                            // (2) vm.customizeë¡œ ê³ ì • IP ì„¤ì •
                            // ==========================================
                            echo ""
                            echo "Step 2: vCenter Guest Customization ì ìš© (ê³ ì • IP ì„¤ì •)..."
                            
                            def customizeCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                            """
                            
                            if (customizationSpecName && customizationSpecName.trim() != '') {
                                // Customization Spec ì‚¬ìš©
                                customizeCommand += """
                                govc vm.customize \\
                                    -vm "${vmName}" \\
                                    -type=Linux \\
                                    -ip="${vmIP}" \\
                                    -netmask="${subnet}" \\
                                    -gateway="${gateway}" \\
                                    -dns-server="${dnsServers}" \\
                                    "${customizationSpecName}"
                                """
                            } else {
                                // Customization Spec ì—†ì´ ì§ì ‘ IP ì„¤ì •
                                customizeCommand += """
                                govc vm.customize \\
                                    -vm "${vmName}" \\
                                    -type=Linux \\
                                    -ip="${vmIP}" \\
                                    -netmask="${subnet}" \\
                                    -gateway="${gateway}" \\
                                    -dns-server="${dnsServers}"
                                """
                            }
                            
                            sh customizeCommand
                            echo "âœ… vCenter Guest Customization ì ìš© ì™„ë£Œ (IP: ${vmIP})"
                            
                            // ==========================================
                            // (3) ì „ì› ON + IP í™•ì¸
                            // ==========================================
                            echo ""
                            echo "Step 3: VM ì „ì› ì¼œê¸° ë° IP í™•ì¸..."
                            
                        def powerOnCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                            export GOVC_INSECURE="${env.GOVC_INSECURE}"
                            
                            govc vm.power -on "${vmName}"
                        """
                        
                        sh powerOnCommand
                            echo "VM ë¶€íŒ… ëŒ€ê¸° ì¤‘..."
                            sleep(time: 20, unit: 'SECONDS')
                        
                            // IP í™•ì¸ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)
                        def maxWait = 300  // 5ë¶„
                        def waitTime = 0
                            def currentVMIP = ''
                        
                            while (waitTime < maxWait && !currentVMIP) {
                            sleep(time: 10, unit: 'SECONDS')
                            waitTime += 10
                            
                            def ipCheckCommand = """
                                    export GOVC_URL="${govcUrl}"
                                    export GOVC_USERNAME="${govcUser}"
                                    export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                                govc vm.ip "${vmName}" | head -1
                            """
                            
                            def ipOutput = sh(
                                script: ipCheckCommand,
                                returnStdout: true
                            ).trim()
                            
                            if (ipOutput && ipOutput != '') {
                                    currentVMIP = ipOutput
                                    echo "âœ… VM IP í™•ì¸: ${currentVMIP}"
                                    break
                            } else {
                                echo "VM IP ì£¼ì†Œ ëŒ€ê¸° ì¤‘... (${waitTime}/${maxWait}ì´ˆ)"
                            }
                        }
                        
                            if (!currentVMIP) {
                                error("VM IP ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. VM ë¶€íŒ… ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                            }
                            
                            // IP ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
                            if (currentVMIP != vmIP) {
                                error("âš ï¸ Guest Customization IP ë¶ˆì¼ì¹˜: í˜„ì¬=${currentVMIP}, ê¸°ëŒ€=${vmIP}")
                            }
                            
                            env.NEW_VM_IP = vmIP
                            echo "âœ… ìµœì¢… VM IP: ${env.NEW_VM_IP}"
                            echo "âœ… ì²« ë¶€íŒ…ë¶€í„° ê³ ì • IP (${vmIP})ë¡œ ì˜¬ë¼ì™”ìŠµë‹ˆë‹¤ (DHCP ë‹¨ê³„ ì—†ìŒ)"
                        
                    } catch (Exception e) {
                        echo "VM í´ë¡  ì‹¤íŒ¨: ${e.getMessage()}"
                        error("VM í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 5: F5 Pool Member ì¶”ê°€
        stage('F5 Pool Registration') {
            steps {
                script {
                    echo "=========================================="
                    echo "F5 Pool Member ì¶”ê°€ ì‹œì‘"
                    echo "=========================================="
                    
                    def poolName = env.F5_POOL_NAME
                    def memberIP = env.NEW_VM_IP
                    def port = env.F5_POOL_PORT.toInteger()
                    
                    if (!poolName || poolName == '') {
                        error("F5 Pool ì´ë¦„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    if (!memberIP || memberIP == 'null' || memberIP == '') {
                        error("VM IP ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // F5 Credential ì‚¬ìš©
                    withCredentials([usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME', passwordVariable: 'F5_PASSWORD')]) {
                        try {
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” curlì„ ì‚¬ìš©í•˜ì—¬ F5 API í˜¸ì¶œ
                            
                            echo "Linux í™˜ê²½ì—ì„œ F5 API í˜¸ì¶œ..."
                            
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ)
                            sh """
                                python3 ${WORKSPACE}/scripts/add-f5-pool-member.py \
                                    --pool ${poolName} \
                                    --member ${memberIP}:${port} \
                                    --server ${env.F5_SERVER} \
                                    --username ${env.F5_USERNAME} \
                                    --password '${env.F5_PASSWORD}'
                            """
                            
                            echo "F5 Pool Member ì¶”ê°€ ì™„ë£Œ: ${memberIP}:${port}"
                        } catch (Exception e) {
                            echo "F5 Pool Member ì¶”ê°€ ì‹¤íŒ¨: ${e.getMessage()}"
                            // F5 ë“±ë¡ ì‹¤íŒ¨ëŠ” ê²½ê³ ë¡œ ì²˜ë¦¬ (VMì€ ì´ë¯¸ ìƒì„±ë¨)
                            currentBuild.result = 'UNSTABLE'
                            echo "ê²½ê³ : F5 Pool ë“±ë¡ ì‹¤íŒ¨í–ˆì§€ë§Œ VMì€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
                        }
                    }
                }
            }
        }
        
        // Stage 6: ê²°ê³¼ ìš”ì•½
        stage('Summary') {
            steps {
                script {
                    echo "=========================================="
                    echo "ì‘ì—… ì™„ë£Œ ìš”ì•½"
                    echo "=========================================="
                    echo "Alert: ${env.alertname}"
                    echo "Service: ${env.ALERT_SERVICE}"
                    echo "Instance: ${env.VM_INSTANCE}"
                    echo "ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}"
                    echo "ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}"
                    echo "F5 Pool: ${env.F5_POOL_NAME}"
                    echo "F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}"
                    echo "=========================================="
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline ì‹¤í–‰ ì™„ë£Œ"
            // ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            script {
                def summary = """
                    Alert: ${env.alertname}
                    Service: ${env.ALERT_SERVICE}
                    Instance: ${env.VM_INSTANCE}
                    ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}
                    ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}
                    F5 Pool: ${env.F5_POOL_NAME}
                    F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}
                    ì‹¤í–‰ ì‹œê°„: ${currentBuild.durationString}
                    ê²°ê³¼: ${currentBuild.result ?: 'SUCCESS'}
                """
                writeFile file: 'pipeline-summary.txt', text: summary
                archiveArtifacts artifacts: 'pipeline-summary.txt', fingerprint: true
            }
        }
        success {
            script {
                echo "âœ… ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì„±ê³µ"
                
                // ë°±ì—”ë“œë¡œ VM ìƒì„± ì™„ë£Œ ì›¹í›… ì „ì†¡
                if (env.NEW_VM_NAME && env.NEW_VM_IP && env.ALERT_SERVICE) {
                    try {
                        def webhookPayload = [
                            serviceName: env.ALERT_SERVICE,
                            vmName: env.NEW_VM_NAME,
                            vmIp: env.NEW_VM_IP,
                            prometheusJobName: env.PROMETHEUS_JOB_NAME ?: '',
                            f5PoolName: env.F5_POOL_NAME ?: '',
                            f5VipPort: env.F5_POOL_PORT ?: '80'
                        ]
                        
                        def webhookResponse = sh(
                            script: """
                                curl -sf -X POST \
                                    -H "Content-Type: application/json" \
                                    -d '${groovy.json.JsonOutput.toJson(webhookPayload)}' \
                                    "${env.BACKEND_API_URL}/api/webhook/jenkins/vm-created"
                            """,
                            returnStdout: true
                        )
                        
                        echo "âœ… ë°±ì—”ë“œ ì›¹í›… ì „ì†¡ ì™„ë£Œ: ${env.NEW_VM_NAME}"
                        echo "ì›¹í›… ì‘ë‹µ: ${webhookResponse}"
                    } catch (Exception e) {
                        echo "âš ï¸ ë°±ì—”ë“œ ì›¹í›… ì „ì†¡ ì‹¤íŒ¨ (ê²½ê³ ): ${e.getMessage()}"
                        // ì›¹í›… ì‹¤íŒ¨í•´ë„ íŒŒì´í”„ë¼ì¸ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
                    }
                } else {
                    echo "âš ï¸ VM ì •ë³´ê°€ ë¶ˆì™„ì „í•˜ì—¬ ë°±ì—”ë“œ ì›¹í›…ì„ ì „ì†¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                }
            }
        }
        failure {
            echo "âŒ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì‹¤íŒ¨"
        }
        unstable {
            echo "âš ï¸ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ë¶€ë¶„ ì‹¤íŒ¨ (VM ìƒì„± ì„±ê³µ, F5 ë“±ë¡ ì‹¤íŒ¨)"
        }
    }
}
