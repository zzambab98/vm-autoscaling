// Jenkins Pipeline í†µí•© ìŠ¤í¬ë¦½íŠ¸ (Linux í™˜ê²½ìš© - govc ì‚¬ìš©)
// Alertmanager Webhook â†’ Jenkins â†’ vCenter API (govc) â†’ F5 Pool ìë™ ë“±ë¡ íŒŒì´í”„ë¼ì¸
// Job ì´ë¦„: plg-autoscale-out

pipeline {
    agent any
    
    // Generic Webhook Trigger ì„¤ì •
    triggers {
        GenericTrigger(
            genericVariables: [
                // Alertmanagerì—ì„œ ì „ë‹¬ë˜ëŠ” ë°ì´í„° íŒŒì‹±
                [key: 'alertname', value: '$.alerts[0].labels.alertname', regexpFilter: ''],
                [key: 'instance', value: '$.alerts[0].labels.instance', regexpFilter: ''],
                [key: 'service', value: '$.alerts[0].labels.service', regexpFilter: ''],
                [key: 'autoscaleConfigId', value: '$.alerts[0].labels.autoscaleConfigId', regexpFilter: ''],
                [key: 'severity', value: '$.alerts[0].labels.severity', regexpFilter: ''],
                [key: 'status', value: '$.status', regexpFilter: ''],
                [key: 'summary', value: '$.alerts[0].annotations.summary', regexpFilter: ''],
                [key: 'description', value: '$.alerts[0].annotations.description', regexpFilter: '']
            ],
            causeString: 'Alert: $alertname - Service: $service - Instance: $instance',
            token: 'plg-autoscale-token',
            printContributedVariables: true,
            printPostContent: true,
            // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ (firingë§Œ ì²˜ë¦¬)
            regexpFilterText: '$status',
            regexpFilterExpression: '^firing$'
        )
    }
    
    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment {
        // vCenter ì„¤ì • (Jenkins Credentials ë˜ëŠ” í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…)
        GOVC_URL = ''
        GOVC_USERNAME = ''
        GOVC_PASSWORD = ''
        GOVC_INSECURE = '1'  // SSL ì¸ì¦ì„œ ê²€ì¦ ë¹„í™œì„±í™”
        
        // ê¸°ë³¸ vCenter ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        VCENTER_RESOURCE_POOL = 'APP-RP'
        VCENTER_DATASTORE = 'OS-Datastore-Power-Store'
        
        // F5 ì„¤ì • (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •ì—ì„œ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ)
        F5_SERVER = '10.255.1.80'
        F5_PARTITION = 'Common'
        F5_HEALTH_MONITOR = '/Common/http'
        F5_USERNAME = ''
        F5_PASSWORD = ''
        
        // ë°±ì—”ë“œ API URL (ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒìš©)
        BACKEND_API_URL = 'http://10.255.48.253:6010'
        
        // íƒ€ì„ì•„ì›ƒ ì„¤ì •
        VM_IP_TIMEOUT = '300'  // 5ë¶„
    }
    
    stages {
        // Stage 1: Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦
        stage('Parse Alert') {
            steps {
                script {
                    echo "=========================================="
                    echo "Alert ë°ì´í„° íŒŒì‹± ë° ê²€ì¦"
                    echo "=========================================="
                    
                    def alertname = env.alertname ?: 'Unknown'
                    def instance = env.instance ?: 'all'
                    def service = env.service ?: 'unknown'
                    def autoscaleConfigId = env.autoscaleConfigId ?: ''
                    def severity = env.severity ?: 'warning'
                    def status = env.status ?: 'unknown'
                    def summary = env.summary ?: ''
                    def description = env.description ?: ''
                    
                    echo "Alert Name: ${alertname}"
                    echo "Service: ${service}"
                    echo "Instance: ${instance}"
                    echo "Autoscale Config ID: ${autoscaleConfigId}"
                    echo "Severity: ${severity}"
                    echo "Status: ${status}"
                    echo "Summary: ${summary}"
                    echo "Description: ${description}"
                    
                    // Resolved ì•Œë¦¼ì€ ë¬´ì‹œ
                    if (status != 'firing') {
                        echo "Alert status is '${status}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Critical ë˜ëŠ” Warning ì•Œë¦¼ë§Œ ì²˜ë¦¬
                    if (severity != 'critical' && severity != 'warning') {
                        echo "Alert severity is '${severity}', skipping scale-out"
                        currentBuild.result = 'ABORTED'
                        return
                    }
                    
                    // Autoscale Config IDê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜
                    if (!autoscaleConfigId) {
                        error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤. Alert Rule ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.")
                    }
                    
                    // í™˜ê²½ ë³€ìˆ˜ ì €ì¥
                    env.VM_INSTANCE = instance
                    env.ALERT_SERVICE = service
                    env.ALERT_SEVERITY = severity
                    env.AUTOSCALE_CONFIG_ID = autoscaleConfigId
                    
                    echo "Alert íŒŒì‹± ì™„ë£Œ. ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì¤‘..."
                }
            }
        }
        
        // Stage 2: ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ
        stage('Get Autoscaling Config') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED'),
                        usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME_CRED', passwordVariable: 'F5_PASSWORD_CRED')
                    ]) {
                        echo "=========================================="
                        echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ"
                       	echo "=========================================="
                        
                        if (!env.GOVC_URL || env.GOVC_URL.trim() == '') {
                            env.GOVC_URL = VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        }
                        if (!env.GOVC_USERNAME || env.GOVC_USERNAME.trim() == '') {
                            env.GOVC_USERNAME = VCENTER_USER_CRED ?: 'svc-auto'
                        }
                        if (!env.GOVC_PASSWORD || env.GOVC_PASSWORD.trim() == '') {
                            if (VCENTER_PASSWORD_CRED && VCENTER_PASSWORD_CRED.trim() != '') {
                                env.GOVC_PASSWORD = VCENTER_PASSWORD_CRED
                            } else {
                                error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Jenkins Credentials 'vcenter-password'ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                            }
                        }
                        
                        env.F5_USERNAME = F5_USERNAME_CRED ?: env.F5_USERNAME
                        env.F5_PASSWORD = F5_PASSWORD_CRED ?: env.F5_PASSWORD
                        
                        def configId = env.AUTOSCALE_CONFIG_ID
                        if (!configId || configId.trim() == '') {
                            error("Autoscale Config IDê°€ ì—†ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            echo "ë°±ì—”ë“œ API í˜¸ì¶œ: ${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}"
                            def configResponseText = sh(
                                script: """curl -sf -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/autoscaling/configs/${configId}" """,
                                returnStdout: true
                            ).trim()
                            
                            def configResponse = new groovy.json.JsonSlurper().parseText(configResponseText)
                            def configData = configResponse.config ?: configResponse
                            
                            // ë””ë²„ê¹…: vCenter ì •ë³´ í™•ì¸
                            echo "ë””ë²„ê¹…: configData.vcenter = ${configData.vcenter}"
                            if (configData.vcenter) {
                                echo "ë””ë²„ê¹…: vcenter.resourcePool = ${configData.vcenter.resourcePool}"
                                echo "ë””ë²„ê¹…: vcenter.datastore = ${configData.vcenter.datastore}"
                            }
                            
                            if (!configData.serviceName) {
                                error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ${configResponseText}")
                            }
                            
                            if (configData.templateId) {
                                echo "ğŸ“ Template ì •ë³´ ì¡°íšŒ: ${configData.templateId}"
                                try {
                                    def templateResponseText = sh(
                                        script: """curl -s -w "\\n%{http_code}" -H "Content-Type: application/json" "${env.BACKEND_API_URL}/api/templates/${configData.templateId}" """,
                                        returnStdout: true
                                    ).trim()

                                    def lines = templateResponseText.split('\n')
                                    def httpCode = lines[-1]
                                    def responseBody = lines[0..-2].join('\n')

                                    echo "ğŸ” Template API HTTP ì‘ë‹µ ì½”ë“œ: ${httpCode}"

                                    if (httpCode == '200') {
                                        def templateJson = new groovy.json.JsonSlurper().parseText(responseBody)
                                        def templateName = templateJson.template?.name ?: templateJson.name

                                        if (templateName && templateName != '' && templateName != 'null') {
                                            env.VCENTER_TEMPLATE = templateName
                                            echo "âœ… Template ì´ë¦„: ${env.VCENTER_TEMPLATE}"
                                        } else {
                                            echo "âš ï¸ Template ì´ë¦„ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                            env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                        }
                                    } else {
                                        echo "âš ï¸ Template API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP ${httpCode}). ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                        env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                    }
                                } catch (Exception tmplErr) {
                                    echo "âš ï¸ Template ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ: ${tmplErr.class.name}"
                                    echo "ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                    env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                                }
                            } else {
                                echo "âš ï¸ templateIdê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©: auto-vm-test-template"
                                env.VCENTER_TEMPLATE = 'auto-vm-test-template'
                            }
                            
                            // VM ì´ë¦„ ìƒì„±: ê¸°ì¡´ VM ëª©ë¡ í™•ì¸ í›„ ë‹¤ìŒ ìˆœì°¨ ë²ˆí˜¸ ìƒì„±
                            def serviceName = configData.serviceName ?: 'app'
                            def serviceNameClean = serviceName.toLowerCase().replaceAll(/[^a-z0-9-]/, '-')

                            // serviceNameì—ì„œ ì ‘ë¯¸ì‚¬ ì œê±° (ì˜ˆ: auto-vm-test-service -> auto-vm-test)
                            def parts = serviceNameClean.split('-')
                            def baseName = serviceNameClean
                            if (parts.size() > 1) {
                                def lastPart = parts[-1]
                                if (lastPart in ['service', 'job', 'app', 'api', 'web']) {
                                    baseName = parts[0..-2].join('-')
                                }
                            }

                            echo "ì„œë¹„ìŠ¤ ì´ë¦„: ${serviceNameClean}"
                            echo "ê¸°ë³¸ ì´ë¦„: ${baseName}"

                            // vCenterì—ì„œ ê¸°ì¡´ VM ëª©ë¡ ì¡°íšŒí•˜ì—¬ ë‹¤ìŒ ë²ˆí˜¸ ê²°ì •
                            def nextVMNumber = 1
                            def vmPrefix = baseName  // ì´ˆê¸°ê°’ ëª…ì‹œì  ì„¤ì •
                            
                            try {
                                def govcUrl = env.GOVC_URL ?: VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                                def govcUser = env.GOVC_USERNAME ?: VCENTER_USER_CRED ?: 'svc-auto'
                                def govcPass = env.GOVC_PASSWORD ?: VCENTER_PASSWORD_CRED
                                
                                if (govcPass && govcPass != 'null' && govcPass.trim() != '') {
                                    // ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ VM ê²€ìƒ‰ (baseNameê³¼ serviceName ëª¨ë‘)
                                    def listVMsCommand = """
                                        export GOVC_URL="${govcUrl}"
                                        export GOVC_USERNAME="${govcUser}"
                                        export GOVC_PASSWORD="${govcPass}"
                                        export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                        
                                        # ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ VM ê²€ìƒ‰
                                        (
                                            govc find / -type m -name "${baseName}-*" 2>/dev/null
                                            govc find / -type m -name "${serviceNameClean}-*" 2>/dev/null
                                        ) | sort -u | \
                                        while read vm; do
                                            vm_name=\$(basename "\$vm")
                                            # ìˆ«ìë¡œ ëë‚˜ëŠ” VM ì´ë¦„ë§Œ ì¶”ì¶œ (ì˜ˆ: auto-vm-test-01, auto-vm-test-02)
                                            if echo "\$vm_name" | grep -qE "^(.+)-[0-9]+\$"; then
                                                echo "\$vm_name"
                                            fi
                                        done | sort -V || echo ""
                                    """
                                    
                                    def existingVMs = sh(
                                        script: listVMsCommand,
                                        returnStdout: true
                                    ).trim()
                                    
                                    echo "ê¸°ì¡´ VM ëª©ë¡: ${existingVMs ?: 'ì—†ìŒ'}"
                                    
                                    if (existingVMs) {
                                        def vmList = existingVMs.split('\n')
                                        def prefixGroups = [:]
                                        
                                        // ê° VM ì´ë¦„ì—ì„œ prefixì™€ ë²ˆí˜¸ ì¶”ì¶œ
                                        vmList.each { vmName ->
                                            def match = vmName =~ /^(.+)-([0-9]+)$/
                                            if (match) {
                                                def prefix = match[0][1]
                                                def number = match[0][2].toInteger()
                                                
                                                if (!prefixGroups[prefix]) {
                                                    prefixGroups[prefix] = []
                                                }
                                                prefixGroups[prefix].add(number)
                                            }
                                        }
                                        
                                        // ê°€ì¥ ë§ì€ VMì„ ê°€ì§„ prefix ì„ íƒ (ë˜ëŠ” baseNameê³¼ ê°€ì¥ ìœ ì‚¬í•œ prefix)
                                        if (prefixGroups) {
                                            // baseNameê³¼ ê°€ì¥ ìœ ì‚¬í•œ prefix ì°¾ê¸°
                                            def bestPrefix = baseName
                                            def bestMatch = prefixGroups.find { it.key == baseName }
                                            
                                            if (!bestMatch) {
                                                // baseNameìœ¼ë¡œ ì‹œì‘í•˜ëŠ” prefix ì°¾ê¸°
                                                bestMatch = prefixGroups.find { it.key.startsWith(baseName) }
                                                if (bestMatch) {
                                                    bestPrefix = bestMatch.key
                                                } else {
                                                    // ê°€ì¥ ë§ì€ VMì„ ê°€ì§„ prefix ì„ íƒ
                                                    def maxEntry = prefixGroups.max { it.value.size() }
                                                    bestPrefix = maxEntry.key
                                                }
                                            }
                                            
                                            vmPrefix = bestPrefix
                                            def numbers = prefixGroups[vmPrefix]
                                            if (numbers && numbers.size() > 0) {
                                                nextVMNumber = numbers.max() + 1
                                                echo "ê¸°ì¡´ VM ë°œê²¬: ì ‘ë‘ì‚¬=${vmPrefix}, ìµœëŒ€ ë²ˆí˜¸=${numbers.max()}, ë‹¤ìŒ ë²ˆí˜¸=${nextVMNumber}"
                                            }
                                        }
                                    }
                                }
                            } catch (Exception vmListErr) {
                                def errorMsg = vmListErr.toString()
                                echo "âš ï¸ ê¸°ì¡´ VM ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${errorMsg}. ë²ˆí˜¸ 1ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤."
                            }
                            
                            // VM ì´ë¦„ ìƒì„± (prefix-XX í˜•ì‹, 2ìë¦¬ ìˆ«ì)
                            env.NEW_VM_NAME = "${vmPrefix}-${String.format('%02d', nextVMNumber)}"
                            env.VM_HOSTNAME = env.NEW_VM_NAME  // í˜¸ìŠ¤íŠ¸ë„¤ì„ë„ ë™ì¼í•˜ê²Œ ì„¤ì •
                            
                            echo "ìƒì„±í•  VM ì´ë¦„: ${env.NEW_VM_NAME}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME}"
                            
                            env.IP_POOL_START = configData.network?.ipPoolStart ?: ''
                            env.IP_POOL_END = configData.network?.ipPoolEnd ?: ''
                            env.SUBNET = configData.network?.subnet ?: '255.255.255.0'
                            env.GATEWAY = configData.network?.gateway ?: ''
                            env.VLAN = configData.network?.vlan ?: ''
                            
                            env.F5_POOL_NAME = configData.f5?.poolName ?: ''
                            env.F5_POOL_PORT = configData.f5?.vipPort ?: '80'
                            env.F5_VIP = configData.f5?.vip ?: ''
                            env.F5_HEALTH_CHECK_PATH = configData.f5?.healthCheckPath ?: '/'
                            
                            // vCenter ì •ë³´ ì„¤ì • (LazyMap ì§ì ‘ ì ‘ê·¼)
                            def vcenterInfo = configData.vcenter
                            def vcenterResourcePool = null
                            def vcenterDatastore = null
                            
                            if (vcenterInfo) {
                                // LazyMapì—ì„œ ì§ì ‘ ê°’ ê°€ì ¸ì˜¤ê¸°
                                vcenterResourcePool = vcenterInfo.get('resourcePool')
                                vcenterDatastore = vcenterInfo.get('datastore')
                                echo "ë””ë²„ê¹…: vcenterInfoì—ì„œ ì¶”ì¶œ - resourcePool=${vcenterResourcePool}, datastore=${vcenterDatastore}"
                            }
                            
                            // vCenter ì„¤ì •ì„ ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¡œ ì €ì¥ (í™˜ê²½ ë³€ìˆ˜ëŠ” ë³€ê²½ ë¶ˆê°€)
                            def finalResourcePool = vcenterResourcePool?.toString()?.trim()
                            if (!finalResourcePool || finalResourcePool == '' || finalResourcePool == 'null') {
                                finalResourcePool = env.VCENTER_RESOURCE_POOL
                                echo "âš  vCenter Resource Pool: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalResourcePool})"
                            } else {
                                echo "âœ“ vCenter Resource Pool: ${finalResourcePool}"
                            }

                            def finalDatastore = vcenterDatastore?.toString()?.trim()
                            if (!finalDatastore || finalDatastore == '' || finalDatastore == 'null') {
                                finalDatastore = env.VCENTER_DATASTORE
                                echo "âš  vCenter Datastore: ê¸°ë³¸ê°’ ì‚¬ìš© (${finalDatastore})"
                            } else {
                                echo "âœ“ vCenter Datastore: ${finalDatastore}"
                            }

                            // ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¥¼ í™˜ê²½ ë³€ìˆ˜ì—ë„ ì €ì¥ (ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œ ì‚¬ìš©)
                            env.FINAL_RESOURCE_POOL = finalResourcePool
                            env.FINAL_DATASTORE = finalDatastore
                            
                            echo "ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì™„ë£Œ:"
                            echo "  Template: ${env.VCENTER_TEMPLATE}"
                            echo "  VM Name: ${env.NEW_VM_NAME}"
                            echo "  IP Pool: ${env.IP_POOL_START} - ${env.IP_POOL_END}"
                            echo "  F5 Pool: ${env.F5_POOL_NAME}"
                            echo "  F5 VIP: ${env.F5_VIP}"
                            echo "  Resource Pool: ${finalResourcePool}"
                            echo "  Datastore: ${finalDatastore}"
                            
                        } catch (Exception e) {
                            error("ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì • ì¡°íšŒ ì‹¤íŒ¨: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 3: IP ì£¼ì†Œ í• ë‹¹
        stage('Allocate IP Address') {
            steps {
                script {
                    echo "=========================================="
                    echo "IP ì£¼ì†Œ í• ë‹¹"
                    echo "=========================================="
                    
                    def ipStart = env.IP_POOL_START
                    def ipEnd = env.IP_POOL_END
                    
                    if (!ipStart || !ipEnd) {
                        error("IP Poolì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // IP Poolì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸°
                    // ê°„ë‹¨í•œ ë°©ë²•: IP Pool ë²”ìœ„ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸
                    def allocatedIP = ''
                    
                    // IP ì£¼ì†Œë¥¼ ìˆ«ìë¡œ ë³€í™˜
                    def ipStartParts = ipStart.split('\\.')
                    def ipEndParts = ipEnd.split('\\.')
                    
                    def startLong = ipStartParts[0].toLong() * 256 * 256 * 256 +
                                   ipStartParts[1].toLong() * 256 * 256 +
                                   ipStartParts[2].toLong() * 256 +
                                   ipStartParts[3].toLong()
                    
                    def endLong = ipEndParts[0].toLong() * 256 * 256 * 256 +
                                 ipEndParts[1].toLong() * 256 * 256 +
                                 ipEndParts[2].toLong() * 256 +
                                 ipEndParts[3].toLong()
                    
                    // IP Pool ë²”ìœ„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IP ì°¾ê¸° (ping í…ŒìŠ¤íŠ¸)
                    for (long ip = startLong; ip <= endLong; ip++) {
                        // ìˆ«ìë¥¼ IPë¡œ ë³€í™˜
                        def octet1 = (ip >> 24) & 0xFF
                        def octet2 = (ip >> 16) & 0xFF
                        def octet3 = (ip >> 8) & 0xFF
                        def octet4 = ip & 0xFF
                        def testIP = "${octet1}.${octet2}.${octet3}.${octet4}"
                        
                        // pingìœ¼ë¡œ IP ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                        def pingResult = sh(
                            script: "ping -c 1 -W 1 ${testIP} > /dev/null 2>&1",
                            returnStatus: true
                        )
                        
                        if (pingResult != 0) {
                            // ping ì‹¤íŒ¨ = IP ì‚¬ìš© ê°€ëŠ¥
                            allocatedIP = testIP
                            break
                        }
                    }
                    
                    if (!allocatedIP) {
                        error("IP Pool (${ipStart} - ${ipEnd})ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ IPë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                    }
                    
                    env.NEW_VM_IP = allocatedIP
                    echo "IP ì£¼ì†Œ í• ë‹¹ ì™„ë£Œ: ${env.NEW_VM_IP}"
                }
            }
        }
        
        // Stage 4: vCenter VM í´ë¡  (govc ì‚¬ìš©)
        stage('VM Clone') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'vcenter-server', variable: 'VCENTER_SERVER_CRED'),
                        string(credentialsId: 'vcenter-user', variable: 'VCENTER_USER_CRED'),
                        string(credentialsId: 'vcenter-password', variable: 'VCENTER_PASSWORD_CRED')
                    ]) {
                        echo "=========================================="
                        echo "vCenter VM í´ë¡  ì‹œì‘ (govc ì‚¬ìš©)"
                        echo "=========================================="
                        
                        def templateName = env.VCENTER_TEMPLATE
                        def vmName = env.NEW_VM_NAME
                        def vmIP = env.NEW_VM_IP
                        def subnet = env.SUBNET
                        def gateway = env.GATEWAY
                        def vlan = env.VLAN
                        def datastore = env.FINAL_DATASTORE ?: env.VCENTER_DATASTORE
                        def resourcePool = env.FINAL_RESOURCE_POOL ?: env.VCENTER_RESOURCE_POOL
                        
                        // vCenter Credentials ì¬í™•ì¸
                        def govcUrl = env.GOVC_URL ?: VCENTER_SERVER_CRED ?: 'https://vc.danacloud.local'
                        def govcUser = env.GOVC_USERNAME ?: VCENTER_USER_CRED ?: 'svc-auto'
                        def govcPass = env.GOVC_PASSWORD ?: VCENTER_PASSWORD_CRED
                        
                        if (!govcPass || govcPass == 'null' || govcPass.trim() == '') {
                            error("vCenter ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                        }
                        
                        try {
                            // govcë¥¼ ì‚¬ìš©í•˜ì—¬ VM í´ë¡ 
                            // ì£¼ì˜: govc vm.cloneì€ IP ì„¤ì •ì„ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ,
                            // í´ë¡  í›„ customization specì„ ì‚¬ìš©í•˜ê±°ë‚˜ ë³„ë„ë¡œ ì„¤ì •í•´ì•¼ í•¨
                            
                            // govc ëª…ë ¹ì–´ ì˜µì…˜ êµ¬ì„±
                            def cloneOptions = "-vm=\"${templateName}\" -on=false"
                            
                            // Datastore ì§€ì •
                            if (datastore && datastore != 'null' && datastore.trim() != '') {
                                cloneOptions += " -ds=\"${datastore}\""
                            }
                            
                            // Resource Pool ì§€ì •
                            if (resourcePool && resourcePool != 'null' && resourcePool.trim() != '') {
                                cloneOptions += " -pool=\"${resourcePool}\""
                            }
                            
                            // Network/VLAN ì§€ì •
                            if (vlan && vlan != 'null' && vlan.trim() != '') {
                                cloneOptions += " -net=\"${vlan}\""
                            }
                            
                            def cloneCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                                govc vm.clone ${cloneOptions} "${vmName}"
                            """
                            
                            echo "VM í´ë¡  ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘..."
                            echo "Template: ${templateName}"
                            echo "VM Name: ${vmName}"
                            echo "Command: govc vm.clone ${cloneOptions} ${vmName}"
                            sh cloneCommand
                        
                            echo "VM í´ë¡  ì™„ë£Œ: ${vmName}"

                            // IP ì£¼ì†Œ ë° í˜¸ìŠ¤íŠ¸ë„¤ì„ ì„¤ì • (govc vm.customize ì‚¬ìš©)
                            echo "=========================================="
                            echo "VMì— ê³ ì • IP ë° í˜¸ìŠ¤íŠ¸ë„¤ì„ ì„¤ì • ì¤‘..."
                            echo "=========================================="
                            echo "í• ë‹¹ëœ IP: ${vmIP}"
                            echo "ì„œë¸Œë„·: ${subnet}"
                            echo "ê²Œì´íŠ¸ì›¨ì´: ${gateway}"
                            echo "í˜¸ìŠ¤íŠ¸ë„¤ì„: ${env.VM_HOSTNAME ?: vmName}"

                            // govc vm.customizeëŠ” -hostname í”Œë˜ê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°
                            // IP ì„¤ì •ì€ VM ë¶€íŒ… í›„ SSHë¡œ ì§ì ‘ ì„¤ì •
                            echo "âš ï¸ govc vm.customizeëŠ” IP ì„¤ì •ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. VM ë¶€íŒ… í›„ SSHë¡œ ì„¤ì •í•©ë‹ˆë‹¤."

                            // VM ì „ì› ì¼œê¸°
                            def powerOnCommand = """
                                export GOVC_URL="${govcUrl}"
                                export GOVC_USERNAME="${govcUser}"
                                export GOVC_PASSWORD="${govcPass}"
                                export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                
                                govc vm.power -on "${vmName}"
                            """
                            
                            sh powerOnCommand
                            echo "VM ì „ì› ì¼œê¸° ì™„ë£Œ: ${vmName}"
                            
                            // VM IP ì£¼ì†Œ í™•ì¸ ëŒ€ê¸° (ì´ˆê¸° ë¶€íŒ… ëŒ€ê¸°)
                            echo "VM ë¶€íŒ… ëŒ€ê¸° ì¤‘..."
                            sleep(time: 30, unit: 'SECONDS')
                            
                            // VM IP ì£¼ì†Œ í™•ì¸ (DHCPë¡œ ë°›ì€ IP)
                            def maxWait = 300  // 5ë¶„
                            def waitTime = 0
                            def vmIPConfirmed = false
                            def currentVMIP = ''
                            
                            while (waitTime < maxWait && !vmIPConfirmed) {
                                sleep(time: 10, unit: 'SECONDS')
                                waitTime += 10
                                
                                def ipCheckCommand = """
                                    export GOVC_URL="${govcUrl}"
                                    export GOVC_USERNAME="${govcUser}"
                                    export GOVC_PASSWORD="${govcPass}"
                                    export GOVC_INSECURE="${env.GOVC_INSECURE}"
                                    
                                    govc vm.ip "${vmName}" | head -1
                                """
                            
                                def ipOutput = sh(
                                    script: ipCheckCommand,
                                    returnStdout: true
                                ).trim()
                                
                                if (ipOutput && ipOutput != '') {
                                    currentVMIP = ipOutput
                                    vmIPConfirmed = true
                                    echo "VM í˜„ì¬ IP ì£¼ì†Œ: ${currentVMIP}"
                                } else {
                                    echo "VM IP ì£¼ì†Œ ëŒ€ê¸° ì¤‘... (${waitTime}/${maxWait}ì´ˆ)"
                                }
                            }
                            
                            if (!vmIPConfirmed || !currentVMIP) {
                                error("VM IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. VM ë¶€íŒ… ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.")
                            }
                            
                            // í• ë‹¹ëœ IPì™€ í˜„ì¬ IPê°€ ë‹¤ë¥´ë©´ SSHë¡œ ì„¤ì •
                            echo "ğŸ” IP ë¹„êµ: í˜„ì¬=${currentVMIP}, í• ë‹¹=${vmIP}, ì¼ì¹˜=${currentVMIP == vmIP}"
                            if (currentVMIP != vmIP) {
                                echo "âš ï¸ VM IPê°€ í• ë‹¹ëœ IPì™€ ë‹¤ë¦…ë‹ˆë‹¤. í˜„ì¬: ${currentVMIP}, í• ë‹¹: ${vmIP}"
                                echo "ğŸ”§ SSHë¥¼ í†µí•´ IP ì„¤ì • ì‹œë„ ì¤‘..."

                                // SSH í‚¤ ê²½ë¡œ í™•ì¸ (ì„¤ì •ì—ì„œ ì§€ì •í•œ í‚¤ ì‚¬ìš©)
                                def sshKey = null

                                // 1ìˆœìœ„: í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬ëœ SSH í‚¤ ê²½ë¡œ (Webhookì—ì„œ ì„¤ì •)
                                if (env.SSH_KEY_PATH) {
                                    echo "ğŸ”‘ ì„¤ì •ì—ì„œ ì§€ì •í•œ SSH í‚¤ ì‚¬ìš©: ${env.SSH_KEY_PATH}"
                                    def keyExists = sh(
                                        script: "test -f ${env.SSH_KEY_PATH} && echo 'exists' || echo 'not found'",
                                        returnStdout: true
                                    ).trim()
                                    if (keyExists == 'exists') {
                                        sshKey = env.SSH_KEY_PATH
                                        echo "âœ… SSH í‚¤ ë°œê²¬: ${sshKey}"
                                    } else {
                                        echo "âš ï¸ ì„¤ì •ì—ì„œ ì§€ì •í•œ SSH í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${env.SSH_KEY_PATH}"
                                    }
                                }

                                // 2ìˆœìœ„: ê¸°ë³¸ í‚¤ ëª©ë¡ì—ì„œ ìë™ ê²€ìƒ‰ (Fallback)
                                if (!sshKey) {
                                    echo "ğŸ”‘ ê¸°ë³¸ SSH í‚¤ ìë™ ê²€ìƒ‰ ì‹œì‘..."
                                    def sshKeys = [
                                        "/home/ubuntu/workspace/vm-autoscaling/pemkey/danainfra",
                                        "/home/ubuntu/workspace/vm-autoscaling/pemkey/dana-cocktail",
                                        "/home/ubuntu/workspace/vm-autoscaling/pemkey/jenkins"
                                    ]
                                    for (def key in sshKeys) {
                                        def keyExists = sh(
                                            script: "test -f ${key} && echo 'exists' || echo 'not found'",
                                            returnStdout: true
                                        ).trim()
                                        echo "  - ${key}: ${keyExists}"
                                        if (keyExists == 'exists') {
                                            sshKey = key
                                            echo "âœ… SSH í‚¤ ë°œê²¬: ${sshKey}"
                                            break
                                        }
                                    }
                                }

                                if (sshKey) {
                                    echo "ğŸ”§ SSH í‚¤ ì‚¬ìš©: ${sshKey}"
                                    // ì„œë¸Œë„· ë§ˆìŠ¤í¬ë¥¼ CIDRë¡œ ë³€í™˜
                                    def subnetMask = subnet
                                    def cidr = sh(
                                        script: """
                                            python3 -c "
import ipaddress
netmask = '${subnetMask}'
# ì„œë¸Œë„· ë§ˆìŠ¤í¬ë¥¼ CIDRë¡œ ë³€í™˜
if netmask == '255.255.255.0':
    cidr = 24
elif netmask == '255.255.0.0':
    cidr = 16
elif netmask == '255.0.0.0':
    cidr = 8
else:
    # ì¼ë°˜ì ì¸ ë³€í™˜
    cidr = sum(bin(int(x)).count('1') for x in netmask.split('.'))
print(cidr)
"
                                        """,
                                        returnStdout: true
                                    ).trim()
                                    
                                    echo "Netplan ì„¤ì •: IP=${vmIP}/${cidr}, Gateway=${gateway}"
                                    
                                    // SSHë¡œ Netplan ì„¤ì •
                                    def maxRetries = 5
                                    def retryCount = 0
                                    def ipConfigured = false
                                    
                                    while (retryCount < maxRetries && !ipConfigured) {
                                        try {
                                            echo "ğŸ”Œ SSH ì—°ê²° ì‹œë„ (${retryCount + 1}/${maxRetries}): ubuntu@${currentVMIP}"
                                            sh """
                                                ssh -i ${sshKey} \\
                                                    -o StrictHostKeyChecking=no \\
                                                    -o ConnectTimeout=10 \\
                                                    ubuntu@${currentVMIP} << 'SSH_EOF'
sudo tee /etc/netplan/01-netcfg.yaml > /dev/null << 'NETPLAN_EOF'
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - ${vmIP}/${cidr}
      gateway4: ${gateway}
      nameservers:
        addresses:
          - 10.255.0.10
NETPLAN_EOF
sudo netplan apply
hostnamectl set-hostname ${vmName}
SSH_EOF
                                            """
                                            ipConfigured = true
                                            echo "âœ… VM IP ì„¤ì • ì™„ë£Œ: ${vmIP}"
                                        } catch (Exception sshErr) {
                                            retryCount++
                                            echo "SSH ì ‘ì† ì‹¤íŒ¨ (${retryCount}/${maxRetries}): ${sshErr.message}"
                                            if (retryCount < maxRetries) {
                                                sleep(time: 10, unit: 'SECONDS')
                                            }
                                        }
                                    }
                                    
                                    if (ipConfigured) {
                                        env.NEW_VM_IP = vmIP
                                        echo "âœ… VM IPê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${vmIP}"
                                    } else {
                                        echo "âš ï¸ VM IP ìë™ ì„¤ì • ì‹¤íŒ¨. í˜„ì¬ IP (${currentVMIP})ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                                        env.NEW_VM_IP = currentVMIP
                                    }
                                } else {
                                    echo "âŒ SSH í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ IP (${currentVMIP})ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                                    env.NEW_VM_IP = currentVMIP
                                }
                            } else {
                                env.NEW_VM_IP = vmIP
                                echo "âœ… VM IPê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤: ${vmIP}"
                            }

                            echo "ğŸ“Œ ìµœì¢… VM IP: ${env.NEW_VM_IP}"
                        
                        } catch (Exception e) {
                            echo "VM í´ë¡  ì‹¤íŒ¨: ${e.getMessage()}"
                            error("VM í´ë¡  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.getMessage()}")
                        }
                    }
                }
            }
        }
        
        // Stage 5: F5 Pool Member ì¶”ê°€
        stage('F5 Pool Registration') {
            steps {
                script {
                    echo "=========================================="
                    echo "F5 Pool Member ì¶”ê°€ ì‹œì‘"
                    echo "=========================================="
                    
                    def poolName = env.F5_POOL_NAME
                    def memberIP = env.NEW_VM_IP
                    def port = env.F5_POOL_PORT.toInteger()
                    
                    if (!poolName || poolName == '') {
                        error("F5 Pool ì´ë¦„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    if (!memberIP || memberIP == 'null' || memberIP == '') {
                        error("VM IP ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    }
                    
                    // F5 Credential ì‚¬ìš©
                    withCredentials([usernamePassword(credentialsId: 'f5-credentials', usernameVariable: 'F5_USERNAME', passwordVariable: 'F5_PASSWORD')]) {
                        try {
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” curlì„ ì‚¬ìš©í•˜ì—¬ F5 API í˜¸ì¶œ
                            
                            echo "Linux í™˜ê²½ì—ì„œ F5 API í˜¸ì¶œ..."
                            
                            // F5 APIë¥¼ ì‚¬ìš©í•˜ì—¬ Pool Member ì¶”ê°€
                            // Python ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš© (ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ)
                            sh """
                                python3 ${WORKSPACE}/scripts/add-f5-pool-member.py \
                                    --pool ${poolName} \
                                    --member ${memberIP}:${port} \
                                    --server ${env.F5_SERVER} \
                                    --username ${env.F5_USERNAME} \
                                    --password '${env.F5_PASSWORD}'
                            """
                            
                            echo "F5 Pool Member ì¶”ê°€ ì™„ë£Œ: ${memberIP}:${port}"
                        } catch (Exception e) {
                            echo "F5 Pool Member ì¶”ê°€ ì‹¤íŒ¨: ${e.getMessage()}"
                            // F5 ë“±ë¡ ì‹¤íŒ¨ëŠ” ê²½ê³ ë¡œ ì²˜ë¦¬ (VMì€ ì´ë¯¸ ìƒì„±ë¨)
                            currentBuild.result = 'UNSTABLE'
                            echo "ê²½ê³ : F5 Pool ë“±ë¡ ì‹¤íŒ¨í–ˆì§€ë§Œ VMì€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
                        }
                    }
                }
            }
        }
        
        // Stage 6: ê²°ê³¼ ìš”ì•½
        stage('Summary') {
            steps {
                script {
                    echo "=========================================="
                    echo "ì‘ì—… ì™„ë£Œ ìš”ì•½"
                    echo "=========================================="
                    echo "Alert: ${env.alertname}"
                    echo "Service: ${env.ALERT_SERVICE}"
                    echo "Instance: ${env.VM_INSTANCE}"
                    echo "ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}"
                    echo "ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}"
                    echo "F5 Pool: ${env.F5_POOL_NAME}"
                    echo "F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}"
                    echo "=========================================="
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline ì‹¤í–‰ ì™„ë£Œ"
            // ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            script {
                def summary = """
                    Alert: ${env.alertname}
                    Service: ${env.ALERT_SERVICE}
                    Instance: ${env.VM_INSTANCE}
                    ìƒˆ VM ì´ë¦„: ${env.NEW_VM_NAME ?: 'N/A'}
                    ìƒˆ VM IP: ${env.NEW_VM_IP ?: 'N/A'}
                    F5 Pool: ${env.F5_POOL_NAME}
                    F5 Member: ${env.NEW_VM_IP ?: 'N/A'}:${env.F5_POOL_PORT}
                    ì‹¤í–‰ ì‹œê°„: ${currentBuild.durationString}
                    ê²°ê³¼: ${currentBuild.result ?: 'SUCCESS'}
                """
                writeFile file: 'pipeline-summary.txt', text: summary
                archiveArtifacts artifacts: 'pipeline-summary.txt', fingerprint: true
            }
        }
        success {
            echo "âœ… ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì„±ê³µ"
        }
        failure {
            echo "âŒ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ì‹¤íŒ¨"
        }
        unstable {
            echo "âš ï¸ ìë™ ìŠ¤ì¼€ì¼ì•„ì›ƒ ë¶€ë¶„ ì‹¤íŒ¨ (VM ìƒì„± ì„±ê³µ, F5 ë“±ë¡ ì‹¤íŒ¨)"
        }
    }
}
